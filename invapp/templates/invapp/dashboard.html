{% extends "invapp/base.html" %}
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% get_available_languages as AVAILABLE_LANGUAGES %}
{% get_language_info_list for AVAILABLE_LANGUAGES as languages %}
{% load static %}
{% block title %}{% translate "Your Dashboard" %}{% endblock %}

{% block page_header %}
    <!--
      NEW: We add x-data here to control the modal.
      We pass the event count and plan limit from Django to Alpine.js.
    -->
    <div x-data="{
          showUpgradeModal: false,
          eventCount: {{ events.count|default:0 }},
          maxEvents: {{ active_plan.max_events|default:0 }}
        }"
        class="sm:flex sm:justify-between sm:items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">{% translate "Dashboard" %}</h1>
            <p class="mt-1 text-md text-gray-600 dark:text-gray-400">
                {% translate "Here are all the events you are currently planning." %}
                <!-- Display Event Usage Limit -->
                {% if active_plan.max_events %}
                    <span class="ml-2 inline-flex items-center rounded-md bg-indigo-50 dark:bg-indigo-900/50 px-2 py-1 text-xs font-medium text-indigo-700 dark:text-indigo-300 ring-1 ring-inset ring-indigo-700/10">
                        {{ events.count }} / {{ active_plan.max_events }} {% translate "events used" %}
                    </span>
                {% endif %}
            </p>
        </div>
        <div class="mt-4 sm:mt-0">
            <!--
              NEW: This is now a "smart" button.
              - It's a <button> instead of an <a>.
              - @click.prevent intercepts the click.
              - It checks the event count vs. the max events.
              - If over limit, it opens the modal.
              - If under limit, it redirects to the create page.
            -->
            <button
                type="button"
                @click.prevent="if (eventCount >= maxEvents) { showUpgradeModal = true } else { window.location.href = '{% url 'invapp:event_create' %}' }"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                {% translate "Create New Event" %}
            </button>
        </div>

        <!-- NEW: The "Upgrade Limit" Modal -->
        <div x-show="showUpgradeModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" style="display: none;">
            <div @click.away="showUpgradeModal = false" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-left">
                <div class="flex items-center justify-center h-12 w-12 mx-auto rounded-full bg-yellow-100 dark:bg-yellow-900/50">
                    <svg class="h-6 w-6 text-yellow-600 dark:text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:mt-5">
                    <h3 class="text-lg font-semibold leading-6 text-gray-900 dark:text-gray-100">{% translate "Event Limit Reached" %}</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">{% blocktranslate with plan_name=active_plan.name %}You have reached the maximum number of events for your <strong>{{ plan_name }}</strong>. To create more events, please upgrade your plan.{% endblocktranslate %}</p>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                    <a href="{% url 'invapp:landing_page' %}#pricing" class="inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 sm:col-start-2">
                        {% translate "Upgrade Now" %}
                    </a>
                    <button @click="showUpgradeModal = false" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 sm:col-start-1 sm:mt-0">
                        {% translate "Cancel" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <!-- Store lock status for use inside the loop -->
    {% with is_locked=request.user.userprofile.plan.lock_event_on_creation %}

    <!-- ============================================== -->
    <!-- === NEW: Plan Status & Upgrade Pitch Card  === -->
    <!-- ============================================== -->
    {% if active_plan %}
        <div class="mb-6">
            {% if active_plan.price == 0 %}
                <!-- FREE PLAN: Show split card with upgrade pitch -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-0 overflow-hidden rounded-lg shadow-lg bg-white dark:bg-gray-800">
                    <!-- Current Plan Details -->
                    <div class="md:col-span-2 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">{% translate "Your Current Plan:" %} <span class="text-indigo-600 dark:text-indigo-400">{{ active_plan.name }}</span></h3>
                        <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">{% translate "Your plan includes the following features:" %}</p>
                        <ul role="list" class="mt-4 space-y-2 text-sm text-gray-700 dark:text-gray-300">
                            <li class="flex items-center space-x-2">
                                <svg class="flex-shrink-0 h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                <span>{% blocktranslate count count=active_plan.max_events %}Up to {{ count }} event{% plural %}Up to {{ count }} events{% endblocktranslate %}</span>
                            </li>
                            <li class="flex items-center space-x-2">
                                <svg class="flex-shrink-0 h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                <!-- === THE FIX: Added 'count' keyword and pluralized 'guest' === -->
                                <span>{% blocktranslate count count=active_plan.max_guests %}Up to {{ count }} guest per event{% plural %}Up to {{ count }} guests per event{% endblocktranslate %}</span>
                            </li>
                            {% if active_plan.has_table_assignment %}
                                <li class="flex items-center space-x-2"><svg class="flex-shrink-0 h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span>{% translate "Table Assignment Tool" %}</span></li>
                            {% else %}
                                <li class="flex items-center space-x-2"><svg class="flex-shrink-0 h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg><span>{% translate "Table Assignment Tool" %}</span></li>
                            {% endif %}
                        </ul>
                    </div>
                    <!-- Upgrade Pitch -->
                    <div class="md:col-span-1 p-6 bg-gray-50 dark:bg-gray-700/50 flex flex-col justify-center">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">{% translate "Unlock More Features" %}</h3>
                        <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">{% translate "Our Premium plans offer unlimited events, more guests, and advanced tools." %}</p>
                        <a href="{% url 'invapp:landing_page' %}#pricing" class="mt-4 w-full text-center inline-flex justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                            {% translate "View Upgrade Options" %}
                        </a>
                    </div>
                </div>
            {% else %}
                <!-- PREMIUM PLAN: Show simple thank you card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">{% translate "Your Plan:" %} <span class="text-indigo-600 dark:text-indigo-400">{{ active_plan.name }}</span></h3>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">{% translate "Thank you for being a premium member! You have access to all our best features." %}</p>
                    <ul role="list" class="mt-4 space-y-2 text-sm text-gray-700 dark:text-gray-300">
                        <!-- Events Limit -->
                        <li class="flex items-center space-x-2">
                            <svg class="flex-shrink-0 h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            <span>{% blocktranslate count count=active_plan.max_events %}Up to {{ count }} event{% plural %}Up to {{ count }} events{% endblocktranslate %}</span>
                        </li>

                        <!-- Guests Limit -->
                        <li class="flex items-center space-x-2">
                            <svg class="flex-shrink-0 h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            <span>{% blocktranslate count count=active_plan.max_guests %}Up to {{ count }} guest per event{% plural %}Up to {{ count }} guests per event{% endblocktranslate %}</span>
                        </li>

                        <!-- Table Assignment -->
                        {% if active_plan.has_table_assignment %}
                            <li class="flex items-center space-x-2">
                                <svg class="flex-shrink-0 h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                <span>{% translate "Table Assignment Tool" %}</span>
                            </li>
                        {% endif %}

                        <!-- Custom Design Upload -->
                        {% if active_plan.can_upload_own_design %}
                             <li class="flex items-center space-x-2">
                                <svg class="flex-shrink-0 h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                <span>{% translate "Custom Design Upload" %}</span>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <!-- THE FIX: The event grid is now wrapped in a container card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-4 sm:p-6">
            {% if events %}
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    {% for event in events %}
                        <div class="bg-white dark:bg-gray-700/50 shadow-md rounded-lg overflow-hidden flex flex-col transition-transform duration-300 hover:scale-105">

                            <div class="aspect-w-16 aspect-h-9 bg-slate-100 dark:bg-gray-700">
                                {% if event.selected_design and event.selected_design.preview_image_path %}
                                    <img src="{% static event.selected_design.preview_image_path %}" alt="{{ event.selected_design.name }} preview" class="w-full h-full object-contain p-2">
                                {% else %}
                                    <div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500 text-sm">{% translate "No Design Preview"}</div>
                                {% endif %}
                            </div>

                            <div class="p-5 flex-grow flex flex-col">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 truncate">{{ event.title }}</h3>

                                <div class="mt-3 flex items-center text-sm text-gray-500 dark:text-gray-400">
                                    <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                    <!-- UPDATED: Use event_date instead of date_time and default text -->
                                    <span>
                                        {{ event.event_date|date:"d M Y"|default:"No Date Set" }}
                                        {% if event.party_time %}
                                            <span class="text-xs ml-1 opacity-75">({{ event.party_time|time:"H:i" }})</span>
                                        {% endif %}
                                    </span>
                                </div>

                                <div class="mt-2 flex items-center text-sm text-gray-500 dark:text-gray-400">
                                    <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                                    <span>{{ event.guests.count }} {% translate "Guest(s)" %}</span>
                                </div>

                                <div class="flex-grow"></div>
                            </div>

                            <div class="border-t border-gray-200 dark:border-gray-600 px-5 py-3 bg-gray-50 dark:bg-gray-700/50 flex flex-col sm:flex-row sm:items-center justify-between gap-3">

                                <div class="flex items-center space-x-3">
                                    <!-- MANAGE GUESTS (Always visible) -->
                                    <a href="{% url 'invapp:guest_list' event_id=event.id %}" class="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300">{% translate "Manage" %}</a>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <!-- EDIT BUTTON: Always available now, restricted by backend -->
                                    <a href="{% url 'invapp:event_edit' pk=event.id %}" class="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">{% translate "Edit" %}</a>

                                    {% if is_locked %}
                                        <!-- Locked Delete -->
                                        <span class="flex items-center text-gray-400 text-sm cursor-not-allowed" title="{% translate 'Deletion is disabled on your current plan' %}">
                                            <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                            {% translate "Delete" %}
                                        </span>
                                    {% else %}
                                        <!-- Unlocked Delete -->
                                        <form action="{% url 'invapp:event_delete' pk=event.id %}" method="post" class="inline">
                                            {% csrf_token %}
                                            <button type="submit" onclick="return confirm('{% translate 'Are you sure you want to delete this event?' %}');" class="text-sm font-medium text-red-600 dark:text-red-500 hover:text-red-800 dark:hover:text-red-400">{% translate "Delete" %}</button>
                                        </form>
                                    {% endif %}

                                    <!-- VIEW INVITE BUTTON -->
                                    {% with first_guest=event.guests.first %}
                                        {% if first_guest and first_guest.unique_id %}
                                            <a href="{% url 'invapp:guest_invite' guest_uuid=first_guest.unique_id %}" target="_blank" class="inline-flex items-center px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-xs font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                                {% translate "View" %}
                                            </a>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <h3 class="mt-2 text-xl font-medium text-gray-900 dark:text-gray-100">{% translate "No events found" %}</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{% translate "Get started by creating your first event." %}</p>
                    <div class="mt-6">
                        <a href="{% url 'invapp:event_create' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">{% translate "+ Create New Event"%}</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    {% endwith %}
{% endblock %}
{% extends "invapp/base.html" %}
{% load i18n %}{% load static %}{% load widget_tweaks %}

{% block title %}
    {% if object %}{% translate "Edit" %} {{ object.title }}{% else %}{% translate "Create Event" %}{% endif %}
{% endblock %}

{% block page_specific_styles %}
<style>
    [x-cloak] { display: none !important; }
    
    .slide-left-enter { transform: translateX(100%); opacity: 0; }
    .slide-left-enter-active { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .slide-left-leave-active { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%); opacity: 0; }
    
    .slide-right-enter { transform: translateX(-100%); opacity: 0; }
    .slide-right-enter-active { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .slide-right-leave-active { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(100%); opacity: 0; }

    .glass-pill {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.4);
    }
    .dark .glass-pill {
        background: rgba(17, 24, 39, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .app-input {
        @apply w-full h-14 px-5 rounded-2xl border-gray-200 dark:border-gray-700 dark:bg-gray-800 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all text-base dark:text-white;
    }
    
    .preview-phone-frame {
        box-shadow: 0 0 0 10px #111827, 0 0 0 12px #374151, 0 40px 60px -15px rgba(0, 0, 0, 0.3);
    }
    
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 16px); }
</style>
{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}
<div class="max-w-[1600px] mx-auto min-h-[100dvh] flex flex-col" 
     x-data="eventWizard()" 
     x-init="init()"
     @input="triggerPreview(false)">

    <div x-show="loading" class="fixed inset-0 z-[110] flex items-center justify-center bg-white/70 backdrop-blur-sm" style="display: none;">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mb-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span class="text-indigo-600 font-bold">{% translate "Saving..." %}</span>
        </div>
    </div>

    <!-- MAIN GRID LAYOUT -->
    <div class="lg:grid lg:grid-cols-12 lg:gap-12 px-4 sm:px-6 lg:px-8 pb-40 lg:pt-4">
        
        <!-- LEFT: FORM SECTION -->
        <div class="lg:col-span-7 xl:col-span-8 relative">
            
            <form method="post" enctype="multipart/form-data" id="event-form" @submit="loading = true">
                {% csrf_token %}
                {{ form.media }}

                <!-- STEP 1: STYLE -->
                <div x-show="step === 1" x-cloak
                     x-transition:enter="slide-left-enter-active" x-transition:enter-start="slide-left-enter"
                     x-transition:leave="slide-left-leave-active" x-transition:leave-end="slide-left-leave"
                     class="space-y-10">
                    
                    <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] p-8 shadow-sm border border-gray-100 dark:border-gray-700">
                        <label class="block text-xl font-bold mb-6 dark:text-white">{% translate "Event Type" %}</label>
                        {% render_field form.event_type class="app-input" x-model="eventType" @change="handleTypeChange()" %}
                    </div>

                    <div class="space-y-6">
                        <h3 class="text-xs font-black uppercase tracking-[0.2em] text-gray-400 ml-4">{% translate "Available Designs" %}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 max-h-[65vh] overflow-y-auto custom-scrollbar pr-2">
                            {% for design in available_designs %}
                            <div class="design-wrapper" data-event-type="{{ design.event_type|lower|slugify }}">
                                <label class="relative block group cursor-pointer">
                                    <input type="radio" name="selected_design" value="{{ design.id }}" class="sr-only peer" 
                                           {% if form.instance.selected_design.id == design.id %}checked{% endif %} required @change="triggerPreview(true)">
                                    <div class="aspect-[3/4] rounded-[2rem] overflow-hidden border-4 border-transparent transition-all duration-300 peer-checked:border-indigo-600 peer-checked:scale-[0.96] shadow-sm peer-checked:shadow-xl">
                                        {% if design.preview_image_path %}
                                            <img src="{% static design.preview_image_path %}" class="w-full h-full object-cover">
                                        {% endif %}
                                        <div class="absolute bottom-4 left-0 w-full text-center">
                                            <span class="inline-block bg-white/90 dark:bg-gray-900/90 backdrop-blur px-3 py-1 rounded-full text-[10px] font-black uppercase text-indigo-600 opacity-0 peer-checked:opacity-100 transition-all">
                                                {{ design.name }}
                                            </span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- STEP 2: INFO & PEOPLE -->
                <div x-show="step === 2" x-cloak
                     x-transition:enter="transition ease-out duration-400" x-transition:enter-start="opacity-0 scale-95"
                     x-transition:leave="transition ease-in duration-300" x-transition:leave-end="opacity-0 scale-95"
                     class="space-y-8">
                    
                    <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] p-8 shadow-sm border border-gray-100 dark:border-gray-700 space-y-8">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center text-indigo-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold dark:text-white">{% translate "Primary Details" %}</h3>
                        </div>

                        <div class="space-y-6">
                            <div><label class="text-xs font-black uppercase text-gray-400">{% translate "Internal Title" %}</label>{% render_field form.title class="app-input mt-2" placeholder="..." required="required" %}</div>
                            
                            <div x-show="!isImageUpload()">
                                <label class="text-xs font-black uppercase text-gray-400">{% translate "Event Date" %}</label>
                                <input type="date" name="event_date" value="{{ form.event_date.value|date:'Y-m-d' }}" class="app-input mt-2" required @change="triggerPreview(true)">
                            </div>

                            <!-- Wedding Block -->
                            <div x-show="isWedding()" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                                    <div><label class="text-xs font-black uppercase tracking-widest text-indigo-400">{% translate "Bride" %}</label>{% render_field form.bride_name class="app-input mt-2" %}</div>
                                    <div><label class="text-xs font-black uppercase tracking-widest text-indigo-400">{% translate "Groom" %}</label>{% render_field form.groom_name class="app-input mt-2" %}</div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t dark:border-gray-700">
                                    <div><label class="text-xs font-black uppercase tracking-widest text-gray-400">{% translate "Bride's Parents" %}</label>{% render_field form.bride_parents class="app-input mt-2" %}</div>
                                    <div><label class="text-xs font-black uppercase tracking-widest text-gray-400">{% translate "Groom's Parents" %}</label>{% render_field form.groom_parents class="app-input mt-2" %}</div>
                                </div>
                            </div>

                            <!-- Baptism Block -->
                            <div x-show="isBaptism()" class="space-y-6 pt-4">
                                <div>
                                    <label class="text-xs font-black uppercase tracking-widest text-indigo-400">{% translate "Child Name" %}</label>
                                    {% render_field form.child_name class="app-input mt-2" %}
                                </div>
                                <div class="pt-4 border-t dark:border-gray-700">
                                    <label class="text-xs font-black uppercase tracking-widest text-gray-400">{% translate "Parents' Names" %}</label>
                                    {% render_field form.parents_names class="app-input mt-2" %}
                                </div>
                            </div>

                            <div x-show="!isImageUpload()" class="pt-6 border-t dark:border-gray-700">
                                <label class="text-xs font-black uppercase text-gray-400">{% translate "Invitation Text" %}</label>
                                {% render_field form.invitation_wording rows="4" class="w-full p-5 rounded-2xl border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white mt-2" %}
                            </div>
                        </div>
                    </div>

                    <!-- Godparents (Only for Wedding/Baptism) -->
                    <div x-show="!isImageUpload()" class="bg-white dark:bg-gray-800 rounded-[2.5rem] p-8 shadow-sm border border-gray-100 dark:border-gray-700 space-y-6">
                        <h3 class="text-xl font-bold dark:text-white">{% translate "Godparents" %}</h3>
                        {{ godparent_formset.management_form }}
                        <div id="godparents-formset-container" class="space-y-4">
                            {% for g_form in godparent_formset %}
                            <div class="godparents-form relative bg-gray-50 dark:bg-gray-900/50 p-6 rounded-[2rem] border border-gray-100 dark:border-gray-800 group">
                                {% for hidden in g_form.hidden_fields %}{{ hidden }}{% endfor %}
                                <div class="hidden">{{ g_form.DELETE }}</div>
                                <button type="button" class="delete-form-btn absolute -top-2 -right-2 w-10 h-10 bg-red-500 text-white rounded-full shadow-lg flex items-center justify-center transform active:scale-75 transition-all">&times;</button>
                                {% render_field g_form.name class="app-input" placeholder="Name" %}
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="add-godparents-btn" class="w-full h-16 border-2 border-dashed border-indigo-200 rounded-[2rem] text-indigo-600 font-black text-xs uppercase tracking-widest">
                            {% translate "+ Add Godparent" %}
                        </button>
                    </div>
                </div>

                <!-- STEP 3: LOCATIONS -->
                <div x-show="step === 3" x-cloak class="space-y-8">
                    <h2 class="text-2xl font-black dark:text-white">{% translate "Locations" %}</h2>
                    <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] p-8 shadow-sm border border-gray-100 dark:border-gray-700 space-y-10">
                        <div class="space-y-6">
                            <h4 class="text-sm font-black uppercase text-indigo-500 tracking-widest">{% translate "Ceremony" %}</h4>
                            {% render_field form.ceremony_location class="app-input" placeholder="Location Name" %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="time" name="ceremony_time" value="{{ form.ceremony_time.value|date:'H:i' }}" class="app-input" @change="triggerPreview(true)">
                                {% render_field form.ceremony_maps_url class="app-input" placeholder="Maps URL" %}
                            </div>
                        </div>
                        
                        <div class="pt-10 border-t dark:border-gray-700 space-y-6">
                            <h4 class="text-sm font-black uppercase text-pink-500 tracking-widest">{% translate "Party" %}</h4>
                            {% render_field form.venue_name class="app-input" placeholder="Venue Name" %}
                            <input type="time" name="party_time" value="{{ form.party_time.value|date:'H:i' }}" class="app-input" @change="triggerPreview(true)">
                            {% render_field form.venue_address class="app-input" placeholder="Address" %}
                            {% render_field form.party_maps_url class="app-input" placeholder="Maps URL" %}
                        </div>
                    </div>
                </div>

                <!-- STEP 4: TIMELINE -->
                <div x-show="step === 4" x-cloak class="space-y-12">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-[2.5rem] shadow-sm border border-gray-100 dark:border-gray-700 space-y-6">
                        <h3 class="text-xl font-bold dark:text-white">{% translate "Event Timeline" %}</h3>
                        {{ schedule_item_formset.management_form }}
                        <div id="schedule_items-formset-container" class="space-y-4">
                            {% for s_form in schedule_item_formset %}
                            <div class="schedule_items-form relative bg-gray-50 dark:bg-gray-900/50 p-6 rounded-[2rem] border border-gray-100 dark:border-gray-800 group">
                                {% for hidden in s_form.hidden_fields %}{{ hidden }}{% endfor %}
                                <div class="hidden">{{ s_form.DELETE }}</div>
                                <button type="button" class="delete-form-btn absolute -top-2 -right-2 w-10 h-10 bg-red-500 text-white rounded-full shadow-lg flex items-center justify-center transform active:scale-75 transition-all">&times;</button>
                                <div class="grid grid-cols-3 gap-4">
                                    <input type="time" name="{{ s_form.time.html_name }}" value="{{ s_form.time.value|date:'H:i' }}" class="app-input" @change="triggerPreview(true)">
                                    <div class="col-span-2">{% render_field s_form.activity_type class="app-input" %}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="add-schedule_items-btn" class="w-full h-16 border-2 border-dashed border-pink-200 rounded-[2rem] text-pink-600 font-black text-xs uppercase tracking-widest">
                            {% translate "+ Add Timeline Item" %}
                        </button>
                    </div>
                </div>

                <!-- STEP 5: MEDIA -->
                <div x-show="step === 5" x-cloak class="space-y-10">
                    <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] p-8 shadow-sm border border-gray-100 dark:border-gray-700 space-y-10">
                        
                        <!-- Couple Photo (Standard) -->
                        <div x-show="!isImageUpload()" class="space-y-4">
                            <label class="block text-xs font-black uppercase tracking-widest text-gray-400">{% translate "Main Cover Image" %}</label>
                            <div class="relative aspect-video bg-gray-50 dark:bg-gray-900 rounded-[2.5rem] overflow-hidden border-2 border-dashed border-gray-200">
                                <input type="file" name="couple_photo" class="absolute inset-0 opacity-0 cursor-pointer z-20" @change="handleFileUpload($event, 'couple_photo')">
                                <template x-if="!previews.couple_photo">
                                    <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span class="text-[10px] font-black uppercase tracking-widest">Tap to Upload</span>
                                    </div>
                                </template>
                                <div class="w-full h-full" x-show="previews.couple_photo">
                                    <img :src="previews.couple_photo" class="w-full h-full object-cover">
                                </div>
                            </div>
                        </div>

                        <!-- Image Upload Only Field -->
                        <div x-show="isImageUpload()" class="space-y-4">
                            <label class="block text-xs font-black uppercase tracking-widest text-gray-400">{% translate "Full Invitation Image" %}</label>
                            <div class="relative aspect-[3/4] bg-gray-50 dark:bg-gray-900 rounded-[2.5rem] overflow-hidden border-2 border-dashed border-gray-200">
                                <input type="file" name="main_invitation_image" class="absolute inset-0 opacity-0 cursor-pointer z-20" @change="handleFileUpload($event, 'main_invitation_image')">
                                <template x-if="!previews.main_invitation_image">
                                    <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span class="text-[10px] font-black uppercase tracking-widest">Upload Your Design</span>
                                    </div>
                                </template>
                                <div class="w-full h-full" x-show="previews.main_invitation_image">
                                    <img :src="previews.main_invitation_image" class="w-full h-full object-contain">
                                </div>
                            </div>
                        </div>

                        <div class="pt-10 border-t dark:border-gray-700">
                            <label class="block text-xs font-black uppercase text-gray-400 tracking-widest mb-4">{% translate "Background Music" %}</label>
                            <div class="bg-indigo-50 dark:bg-indigo-900/20 p-6 rounded-[2rem] flex items-center gap-4">
                                <div class="w-12 h-12 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>
                                </div>
                                <div class="flex-1 overflow-hidden">{{ form.audio_greeting }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- RIGHT: PERSISTENT PREVIEW -->
        <div class="hidden lg:block lg:col-span-5 xl:col-span-4">
            <div class="sticky top-24">
                <div class="relative mx-auto w-full max-w-[310px] h-[calc(100vh-200px)] min-h-[500px] preview-phone-frame bg-gray-900 rounded-[3rem] overflow-hidden border-[10px] border-gray-800">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-24 h-6 bg-gray-800 rounded-b-2xl z-20"></div>
                    <iframe id="persistent-preview-iframe" class="w-full h-full bg-white border-0" src="about:blank"></iframe>
                    <div id="iframe-loader" class="absolute inset-0 bg-white/80 flex items-center justify-center z-10 hidden">
                        <svg class="animate-spin h-8 w-8 text-indigo-600" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </div>
                </div>
                <button type="button" onclick="runPreview()" class="mt-6 mx-auto flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.3em] text-gray-400 hover:text-indigo-600 transition-all group">
                    <svg class="w-3 h-3 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    {% translate "Refresh Preview" %}
                </button>
            </div>
        </div>
    </div>

    <!-- THE FLOATING ACTION PILL -->
    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[94%] max-w-lg z-50 transition-all" 
         :class="showMobilePreview ? 'opacity-0 pointer-events-none' : 'opacity-100' ">
        <div class="glass-pill h-20 rounded-full px-4 flex items-center justify-between shadow-2xl">
            
            <button type="button" @click="prev()" x-show="step > 1" x-transition
                    class="w-14 h-14 flex items-center justify-center text-gray-400 hover:text-gray-900 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div x-show="step === 1" class="w-14 h-14"></div>

            <div class="flex-1 px-4" x-show="!(isImageUpload() && step === 2)">
                <button type="button" @click="next()" x-show="step < 5"
                        :disabled="!stepValid"
                        :class="stepValid ? 'bg-indigo-600 shadow-indigo-200' : 'bg-gray-300 dark:bg-gray-700 cursor-not-allowed grayscale' "
                        class="w-full h-14 rounded-full text-white font-black text-xs uppercase tracking-widest transition-all shadow-xl active:scale-95 flex items-center justify-center gap-2">
                    <span x-text="step === 4 ? '{% translate 'Final Step' %}' : '{% translate 'Next Step' %}'"></span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <button type="submit" form="event-form" x-show="step === 5"
                        class="w-full h-14 rounded-full bg-green-600 text-white font-black text-xs uppercase tracking-widest shadow-xl active:scale-95">
                    {% translate "Ready to Save" %}
                </button>
            </div>
            
            <!-- Quick Finish for Image Upload -->
            <div class="flex-1 px-4" x-show="isImageUpload() && step === 2">
                 <button type="button" @click="step = 5; validateStep();" class="w-full h-14 rounded-full bg-indigo-600 text-white font-black text-xs uppercase tracking-widest shadow-xl active:scale-95">
                    {% translate "Go to Upload" %}
                </button>
            </div>

            <button type="button" @click="openMobilePreview()" 
                    class="lg:hidden w-14 h-14 flex items-center justify-center text-indigo-600 relative">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                <span class="absolute top-3 right-3 w-2 h-2 bg-indigo-500 rounded-full border-2 border-white dark:border-gray-900 animate-pulse"></span>
            </button>
            <div class="hidden lg:block w-14 h-14"></div>
        </div>
    </div>

    <!-- FULLSCREEN MOBILE PREVIEW -->
    <div x-show="showMobilePreview" x-cloak
         x-transition:enter="transition ease-out duration-500" x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
         x-transition:leave="transition ease-in duration-400" x-transition:leave-start="translate-y-0" x-transition:leave-end="translate-y-full"
         class="fixed inset-0 z-[100] bg-white dark:bg-gray-900 flex flex-col lg:hidden">
        <div class="p-5 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50 backdrop-blur-xl">
            <span class="text-[10px] font-black tracking-widest uppercase text-gray-400">{% translate "Live View" %}</span>
            <button @click="showMobilePreview = false" class="w-10 h-10 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center text-gray-500">&times;</button>
        </div>
        <div class="flex-1 w-full bg-white relative">
             <iframe id="preview-iframe" class="w-full h-full border-0"></iframe>
        </div>
    </div>
</div>

<script>
function eventWizard() {
    return {
        step: 1,
        stepValid: false,
        eventType: '',
        showMobilePreview: false,
        previews: { couple_photo: null, main_invitation_image: null },
        previewTimer: null,
        
        init() {
            this.eventType = document.getElementById('id_event_type')?.value || '';
            this.handleTypeChange();
            this.validateStep();
            this.initFormset('godparents');
            this.initFormset('schedule_items');
            this.triggerPreview(true);
        },

        next() {
            if (this.step < 5) {
                // Skip logic for Image Upload
                if (this.isImageUpload() && this.step === 2) { this.step = 5; }
                else { this.step++; }
                
                this.validateStep();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                this.triggerPreview(true);
            }
        },

        prev() {
            if (this.step > 1) {
                if (this.isImageUpload() && this.step === 5) { this.step = 2; }
                else { this.step--; }
                
                this.validateStep();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },

        isWedding() {
            const val = this.eventType.toLowerCase();
            return val === 'wedding' || (!val.includes('botez') && val !== 'baptism' && val !== 'image_upload');
        },
        isBaptism() {
            const val = this.eventType.toLowerCase();
            return val.includes('botez') || val === 'baptism';
        },
        isImageUpload() {
            return this.eventType === 'image_upload';
        },

        handleTypeChange() {
            const val = this.eventType.toLowerCase();
            document.querySelectorAll('.design-wrapper').forEach(opt => {
                const type = opt.dataset.eventType || '';
                opt.style.display = (type.includes(val) || val === '') ? 'block' : 'none';
            });
            this.validateStep();
            this.triggerPreview(true);
        },

        validateStep() {
            const currentStepEl = document.querySelector(`.step-content[data-step="${this.step}"]`);
            if (!currentStepEl) { this.stepValid = true; return; }
            const required = [...currentStepEl.querySelectorAll('input[required], select[required]')];
            this.stepValid = required.every(i => {
                if (i.type === 'radio') return document.querySelector(`input[name="${i.name}"]:checked`);
                return i.value.trim() !== '';
            });
        },

        handleFileUpload(e, key) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ex) => { this.previews[key] = ex.target.result; this.triggerPreview(true); };
                reader.readAsDataURL(file);
            }
        },

        openMobilePreview() {
            this.showMobilePreview = true;
            this.triggerPreview(true);
        },

        triggerPreview(immediate = false) {
            clearTimeout(this.previewTimer);
            if (immediate) { runPreview(); } 
            else { this.previewTimer = setTimeout(() => runPreview(), 100); }
        },

        initFormset(prefix) {
            const btn = document.getElementById(`add-${prefix}-btn`);
            const container = document.getElementById(`${prefix}-formset-container`);
            const total = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
            const tpl = document.getElementById(`empty-${prefix}-form`)?.innerHTML;

            btn?.addEventListener('click', () => {
                const count = parseInt(total.value);
                if (tpl) {
                    container.insertAdjacentHTML('beforeend', tpl.replace(/__prefix__/g, count));
                    total.value = count + 1;
                    this.triggerPreview(true);
                }
            });

            container?.addEventListener('click', (e) => {
                if (e.target.closest('.delete-form-btn')) {
                    const row = e.target.closest(`.${prefix}-form`);
                    const del = row.querySelector(`input[name$="-DELETE"]`);
                    if (del) { del.checked = true; row.style.display = 'none'; }
                    else row.remove();
                    this.triggerPreview(true);
                }
            });
        }
    }
}

async function runPreview() {
    const form = document.getElementById('event-form');
    const pIframe = document.getElementById('persistent-preview-iframe');
    const mIframe = document.getElementById('preview-iframe');
    const loader = document.getElementById('iframe-loader');
    if (loader) loader.classList.remove('hidden');
    const formData = new FormData(form);
    const data = {};
    for (let [k, v] of formData.entries()) { if (!(v instanceof File)) data[k] = v; }
    try {
        const res = await fetch("{% url 'invapp:event_preview' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(data)
        });
        const html = await res.text();
        if (pIframe) pIframe.srcdoc = html;
        if (mIframe) mIframe.srcdoc = html;
    } catch (e) { } finally { if (loader) loader.classList.add('hidden'); }
}
</script>

<template id="empty-godparents-form">
    <div class="godparents-form relative bg-gray-50 dark:bg-gray-900/50 p-6 rounded-[2rem] border border-gray-100 dark:border-gray-800 mt-4">
        <button type="button" class="delete-form-btn absolute -top-2 -right-2 w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        <input type="text" name="godparents-__prefix__-name" class="app-input" placeholder="Full Name">
    </div>
</template>

<template id="empty-schedule_items-form">
    <div class="schedule_items-form relative bg-gray-50 dark:bg-gray-900/50 p-6 rounded-[2rem] border border-gray-100 dark:border-gray-800 mt-4">
        <button type="button" class="delete-form-btn absolute -top-2 -right-2 w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        <div class="grid grid-cols-3 gap-4">
            <input type="time" name="schedule_items-__prefix__-time" class="app-input">
            <input type="text" name="schedule_items-__prefix__-activity_type" class="app-input col-span-2" placeholder="Activity">
        </div>
    </div>
</template>
{% endblock %}

{% extends "invapp/base.html" %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
    {% if object %}
        {% translate "Editare Eveniment:" %} {{ object.title }}
    {% else %}
        {% translate "Creează Eveniment Nou" %}
    {% endif %}
{% endblock %}

{% block page_specific_styles %}
<style>
    /* Wizard Steps Transition */
    .step-content {
        display: none;
        animation: fadeIn 0.4s ease-in-out;
    }
    .step-content.active {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Design Radio Selector Override */
    .design-radio-input:checked + .design-card {
        border-color: #4F46E5; /* Indigo-600 */
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        transform: scale(1.02);
    }
    .design-radio-input:checked + .design-card .check-icon {
        opacity: 1;
        transform: scale(1);
    }

    /* Mobile Sticky Bar SafeArea */
    .safe-area-bottom {
        padding-bottom: env(safe-area-inset-bottom, 20px);
    }

    /* Loading Spinner Overlay */
    .loading-overlay {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(4px);
    }

    /* Custom Scrollbar for Design Grid */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto pb-32 lg:pb-12 px-4 sm:px-6 lg:px-8" x-data="{ loading: false }">

    <!-- Loading State -->
    <div x-show="loading" class="fixed inset-0 z-50 flex items-center justify-center loading-overlay" style="display: none;">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-indigo-600 font-bold animate-pulse">{% translate "Se procesează..." %}</span>
        </div>
    </div>

    <!-- Header & Progress Bar -->
    <div class="py-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                {% if object %}{% translate "Modifică Detaliile" %}{% else %}{% translate "Configurează Evenimentul" %}{% endif %}
            </h1>
            <span class="text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full dark:bg-indigo-900 dark:text-indigo-200">
                Pasul <span id="current-step-label">1</span> din 5
            </span>
        </div>

        <!-- Stepper Visual -->
        <div class="relative">
            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200 dark:bg-gray-700">
                <div id="progress-bar" style="width: 20%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-600 transition-all duration-500"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-500 font-medium px-1">
                <span class="step-label text-indigo-600 font-bold">1. Design</span>
                <span class="step-label">2. Detalii</span>
                <span class="step-label">3. Locație</span>
                <span class="step-label">4. Invitați</span>
                <span class="step-label">5. Media</span>
            </div>
        </div>
    </div>

    {% if is_locked_plan %}
    <div class="mb-6 rounded-md bg-yellow-50 dark:bg-yellow-900/50 p-4 border-l-4 border-yellow-400">
        <div class="flex">
            <div class="ml-3">
                <p class="text-sm text-yellow-700 dark:text-yellow-300">
                    {% translate "Planul tău blochează anumite detalii (Dată, Tip, Design)." %}
                    <a href="{% url 'invapp:landing_page' %}#pricing" class="font-medium underline">{% translate "Upgrade" %}</a>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="event-form" class="space-y-6" @submit="loading = true">
        {% csrf_token %}

        <!-- Errors Summary -->
        {% if form.errors or godparent_formset.errors or schedule_item_formset.errors or gallery_image_formset.errors %}
        <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 mb-6 rounded-md">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700 dark:text-red-200">
                        {% translate "Vă rugăm să corectați erorile de mai jos." %}
                    </p>
                    {{ form.non_field_errors }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ========================== STEP 1: TIP & DESIGN ========================== -->
        <div class="step-content active" data-step="1">
            <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 space-y-6">

                <!-- Tip Eveniment -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2">{% translate "Ce fel de eveniment organizați?" %}</label>
                    <div class="relative">
                        {% render_field form.event_type class="block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}

                        {% if is_locked_plan %}
                            <input type="hidden" name="event_type" value="{{ form.instance.event_type }}">
                        {% endif %}
                    </div>
                    {% if form.event_type.errors %}
                        <p class="mt-2 text-sm text-red-600">{{ form.event_type.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Selector Design (Grid) -->
                <div id="design-selection-container">
                    <label class="block text-lg font-bold text-gray-900 dark:text-white mb-4">{% translate "Alegeți Designul Invitației" %}</label>

                    <!-- Folosim available_designs din context pentru a avea acces la proprietățile obiectelor -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto p-1 custom-scrollbar {% if is_locked_plan %}opacity-60 pointer-events-none{% endif %}">
                        {% for design in available_designs %}
                        <div class="relative design-option design-wrapper" data-event-type="{{ design.event_type|lower|slugify }}">
                            <label class="cursor-pointer group block h-full">
                                <!-- Radio Input Manual -->
                                <input type="radio" name="selected_design" value="{{ design.id }}"
                                       id="design_{{ design.id }}"
                                       class="peer sr-only"
                                       {% if form.instance.selected_design.id == design.id %}checked{% endif %}
                                       {% if is_locked_plan %}disabled{% endif %}>

                                <div class="design-card rounded-xl border-2 border-gray-200 dark:border-gray-700 overflow-hidden bg-white dark:bg-gray-900 transition-all h-full flex flex-col relative hover:border-indigo-300 peer-checked:border-indigo-600 peer-checked:ring-2 peer-checked:ring-indigo-600 peer-checked:ring-offset-2">
                                    <!-- Image Preview -->
                                    <div class="aspect-w-3 aspect-h-4 bg-gray-100 dark:bg-gray-800 relative">
                                        {% if design.preview_image_path %}
                                            <img src="{% static design.preview_image_path %}" alt="{{ design.name }}" class="object-cover w-full h-48">
                                        {% else %}
                                            <div class="flex items-center justify-center h-48 bg-gray-100 text-gray-400 text-xs">Fără Preview</div>
                                        {% endif %}

                                        <!-- Checkmark Badge -->
                                        <div class="check-icon absolute top-2 right-2 bg-indigo-600 text-white rounded-full p-1 transition-all duration-200 shadow-md opacity-0 transform scale-0 peer-checked:opacity-100 peer-checked:scale-100">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                        </div>
                                    </div>
                                    <div class="p-3 text-center bg-white dark:bg-gray-800">
                                        <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ design.name }}</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    {% if is_locked_plan %}
                        <input type="hidden" name="selected_design" value="{{ form.instance.selected_design.id }}">
                    {% endif %}

                    {% if form.selected_design.errors %}
                        <p class="mt-2 text-sm text-red-600">{{ form.selected_design.errors.0 }}</p>
                    {% endif %}
                </div>

            </div>
        </div>

        <!-- ========================== STEP 2: DETALII EVENIMENT ========================== -->
        <div class="step-content" data-step="2">
            <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 space-y-6">

                <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white border-b pb-2">{% translate "Informații Principale" %}</h3>

                <!-- Titlu Intern -->
                <div id="field-title-container">
                    <label for="id_title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% translate "Nume Eveniment (Intern)" %}</label>
                    {% render_field form.title class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg py-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Ex: Nunta Ana & Andrei" %}
                    <p class="mt-1 text-xs text-gray-500">{% translate "Acest nume apare doar în dashboard-ul tău." %}</p>
                    {% if form.title.errors %}<p class="text-sm text-red-600 mt-1">{{ form.title.errors.0 }}</p>{% endif %}
                </div>

                <!-- Data Eveniment -->
                <div id="field-event_date-container">
                    <label for="id_event_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% translate "Data Evenimentului" %}</label>
                    <input type="date" name="event_date" id="id_event_date" value="{{ form.event_date.value|date:'Y-m-d' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg py-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white" {% if is_locked_plan %}disabled{% endif %}>

                    {% if is_locked_plan %}
                        <input type="hidden" name="event_date" value="{{ form.instance.event_date|date:'Y-m-d' }}">
                    {% endif %}
                    {% if form.event_date.errors %}<p class="text-sm text-red-600 mt-1">{{ form.event_date.errors.0 }}</p>{% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Miri / Protagonisti -->
                    <div id="field-bride_name-container" class="conditional-field">
                        <label for="id_bride_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% translate "Prenume Mireasă" %}</label>
                        {% render_field form.bride_name class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 h-12 dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                    </div>
                    <div id="field-groom_name-container" class="conditional-field">
                        <label for="id_groom_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% translate "Prenume Mire" %}</label>
                        {% render_field form.groom_name class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 h-12 dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                    </div>
                    <!-- For Baptism -->
                    <div id="field-child_name-container" class="conditional-field hidden">
                        <label for="id_child_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% translate "Nume Copil (Botez)" %}</label>
                        {% render_field form.child_name class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 h-12 dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                    </div>
                </div>

                <!-- Parents -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                    <div id="field-bride_parents-container" class="conditional-field">
                        <label for="id_bride_parents" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% translate "Părinții Miresei" %}</label>
                        {% render_field form.bride_parents rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                    </div>
                    <div id="field-groom_parents-container" class="conditional-field">
                        <label for="id_groom_parents" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% translate "Părinții Mirelui" %}</label>
                        {% render_field form.groom_parents rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                    </div>
                </div>

                <div id="field-invitation_wording-container">
                    <label for="id_invitation_wording" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">{% translate "Text Invitație (Introductiv)" %}</label>
                    {% render_field form.invitation_wording rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Noi, alături de părinți..." %}
                    <p class="text-xs text-gray-500 mt-1">{% translate "Acest text apare la începutul invitației." %}</p>
                </div>

            </div>
        </div>

         <!-- Text Invitație -->


        <!-- ========================== STEP 3: LOCAȚIE & PROGRAM ========================== -->
        <div class="step-content" data-step="3">
            <div class="space-y-6">

                <!-- Locations Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Ceremony -->
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-l-4 border-indigo-500">
                        <h4 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                            {% translate "Cununia / Ceremonia" %}
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold uppercase text-gray-500">{% translate "Ora" %}</label>
                                <input type="time" name="ceremony_time" id="id_ceremony_time" value="{{ form.ceremony_time.value|date:'H:i' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm h-12 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase text-gray-500">{% translate "Locația (Nume)" %}</label>
                                {% render_field form.ceremony_location class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase text-gray-500">{% translate "Link Waze/Maps" %}</label>
                                {% render_field form.ceremony_maps_url class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="https://maps.google.com/..." %}
                            </div>
                        </div>
                    </div>

                    <!-- Party -->
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-l-4 border-pink-500">
                        <h4 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.701 2.701 0 00-1.5-.454M9 6v2m3-2v2m3-2v2M9 3h.01M12 3h.01M15 3h.01M21 21v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7h18zm-3-9v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2h12z"></path></svg>
                            {% translate "Petrecerea" %}
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold uppercase text-gray-500">{% translate "Ora" %}</label>
                                <input type="time" name="party_time" id="id_party_time" value="{{ form.party_time.value|date:'H:i' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm h-12 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase text-gray-500">{% translate "Locația (Nume)" %}</label>
                                {% render_field form.venue_name class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase text-gray-500">{% translate "Adresa Completă" %}</label>
                                {% render_field form.venue_address class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase text-gray-500">{% translate "Link Waze/Maps" %}</label>
                                {% render_field form.party_maps_url class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Formset -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mt-6" id="schedule-items-section">
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                        <span>{% translate "Cronologie (Timeline)" %}</span>
                        <span class="text-xs font-normal text-gray-500">{% translate "Adaugă momente cheie" %}</span>
                    </h3>

                    {{ schedule_item_formset.management_form }}
                    <div id="schedule_items-formset-container" class="space-y-4">
                        {% for form in schedule_item_formset %}
                            <div class="schedule_items-form bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 relative group">
                                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                <div class="hidden">{{ form.DELETE }}</div> <!-- Hidden Delete Checkbox -->

                                <div class="grid grid-cols-12 gap-4 items-start">
                                    <div class="col-span-4 sm:col-span-3">
                                        <label class="block text-xs text-gray-500">{% translate "Ora" %}</label>
                                        {% render_field form.time class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                                    </div>
                                    <div class="col-span-8 sm:col-span-8">
                                        <label class="block text-xs text-gray-500">{% translate "Activitate" %}</label>
                                        {% render_field form.activity_type class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                                        <label class="block text-xs text-gray-500 mt-2">{% translate "Descriere (Opțional)" %}</label>
                                        {% render_field form.description class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                                    </div>
                                    <div class="col-span-12 sm:col-span-1 flex justify-end items-center pt-4">
                                        {% if schedule_item_formset.can_delete %}
                                            <button type="button" class="delete-form-btn text-red-500 hover:text-red-700 p-2 bg-white dark:bg-gray-800 rounded-full shadow-sm">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-schedule_items-btn" class="mt-4 w-full flex items-center justify-center py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-indigo-500 hover:text-indigo-500 transition-colors font-medium">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        {% translate "Adaugă Activitate în Program" %}
                    </button>
                </div>

                <!-- Hidden Template for Empty Form (Schedule) -->
                <div id="empty-schedule_items-form" class="hidden">
                    <div class="schedule_items-form bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 relative mt-4">
                        <div class="grid grid-cols-12 gap-4 items-start">
                            <div class="col-span-4 sm:col-span-3">
                                <label class="block text-xs text-gray-500">{% translate "Ora" %}</label>
                                {% render_field schedule_item_formset.empty_form.time class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                            </div>
                            <div class="col-span-8 sm:col-span-8">
                                <label class="block text-xs text-gray-500">{% translate "Activitate" %}</label>
                                {% render_field schedule_item_formset.empty_form.activity_type class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                                <label class="block text-xs text-gray-500 mt-2">{% translate "Descriere (Opțional)" %}</label>
                                {% render_field schedule_item_formset.empty_form.description class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                            </div>
                            <div class="col-span-12 sm:col-span-1 flex justify-end pt-4">
                                <div class="hidden">{{ schedule_item_formset.empty_form.DELETE }}</div>
                                <button type="button" class="delete-form-btn text-red-500 hover:text-red-700 p-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================== STEP 4: INVITAȚI SPECIALI (NAȘI) ========================== -->
        <div class="step-content" data-step="4">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                <h3 class="text-lg font-bold mb-4">{% translate "Nași de Cununie / Botez" %}</h3>
                <p class="text-sm text-gray-500 mb-6">{% translate "Adăugați numele nașilor așa cum doriți să apară pe invitație (ex: 'Ion și Maria Popescu' sau separat)." %}</p>

                {{ godparent_formset.management_form }}
                <div id="godparents-formset-container" class="space-y-4">
                    {% for form in godparent_formset %}
                        <div class="godparents-form bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg border border-indigo-100 dark:border-indigo-800 flex items-center justify-between">
                            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                            <div class="flex-grow mr-4">
                                <label class="block text-xs font-bold text-indigo-700 dark:text-indigo-300 uppercase mb-1">{% translate "Nume Naș(i)" %}</label>
                                {% render_field form.name class="mt-1 block w-full rounded-md border-indigo-200 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                            </div>

                            <div class="hidden">{{ form.DELETE }}</div>
                            {% if godparent_formset.can_delete and form.instance.pk %}
                                <button type="button" class="delete-form-btn text-gray-400 hover:text-red-500 p-2 mt-4 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <button type="button" id="add-godparents-btn" class="mt-6 w-full py-3 bg-indigo-50 dark:bg-gray-700 text-indigo-700 dark:text-indigo-300 rounded-lg font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    {% translate "Adaugă încă o pereche de nași" %}
                </button>

                 <!-- Hidden Template for Empty Form (Godparent) -->
                 <div id="empty-godparents-form" class="hidden">
                    <div class="godparents-form bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg border border-indigo-100 dark:border-indigo-800 flex items-center justify-between mt-4">
                        <div class="flex-grow mr-4">
                             <label class="block text-xs font-bold text-indigo-700 dark:text-indigo-300 uppercase mb-1">{% translate "Nume Naș(i)" %}</label>
                            {% render_field godparent_formset.empty_form.name class="mt-1 block w-full rounded-md border-indigo-200 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" %}
                        </div>
                        <div class="hidden">{{ godparent_formset.empty_form.DELETE }}</div>
                        <button type="button" class="delete-form-btn text-gray-400 hover:text-red-500 p-2 mt-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================== STEP 5: MEDIA & CONȚINUT ========================== -->
        <div class="step-content" data-step="5">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 space-y-8">

                <!-- Main Photo -->
                <div id="field-couple_photo-container">
                    <label class="block text-lg font-bold text-gray-900 dark:text-white mb-2">{% translate "Poza Principală (Mirii/Bebelușul)" %}</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-indigo-500 transition-colors bg-gray-50 dark:bg-gray-900">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                <label for="id_couple_photo" class="relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 px-2">
                                    <span>{% translate "Încarcă o poză" %}</span>
                                    {{ form.couple_photo }}
                                </label>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 5MB</p>
                            {% if object.couple_photo %}
                                <div class="mt-4">
                                    <p class="text-xs font-bold text-green-600">{% translate "Poza Curentă:" %}</p>
                                    <img src="{{ object.couple_photo.url }}" class="h-24 object-contain mx-auto rounded shadow-sm">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Galerie Foto (Formset Reintrodus) -->
                <div class="mt-10 pt-6 border-t border-slate-200">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            Galerie Foto
                        </h3>
                        <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">
                            Poți încărca până la 6 fotografii. (Format recomandat: JPG/PNG, max 5MB)
                        </p>
                    </div>

                    {{ gallery_image_formset.management_form }}

                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for form in gallery_image_formset %}
                            <div class="relative bg-slate-50 dark:bg-gray-700 rounded-xl border border-slate-200 dark:border-gray-600 p-4 shadow-sm hover:shadow-md transition-shadow">
                                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

                                {% if form.instance.pk and form.instance.image %}
                                    <div class="mb-4">
                                        <div class="aspect-w-16 aspect-h-9 w-full overflow-hidden rounded-lg bg-gray-200 mb-2">
                                            <img src="{{ form.instance.image.url }}" alt="Imagine galerie" class="h-32 w-full object-cover">
                                        </div>

                                        {% if gallery_image_formset.can_delete %}
                                            <div class="flex items-center justify-between px-1">
                                                <span class="text-xs font-semibold text-slate-600 dark:text-gray-300">Șterge?</span>
                                                {{ form.DELETE }}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="mb-2 flex justify-center items-center h-32 bg-white dark:bg-gray-600 border-2 border-dashed border-slate-300 rounded-lg">
                                        <span class="text-slate-400 text-xs">Liber</span>
                                    </div>
                                {% endif %}

                                <div class="mt-2">
                                    {{ form.image }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Audio Greeting -->
                <div id="field-audio_greeting-container" class="mt-6 border-t pt-6">
                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">{% translate "Mesaj Audio / Muzică de fundal" %}</label>
                    <input type="file" name="audio_greeting" id="id_audio_greeting" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

            </div>
        </div>

        <!-- ========================== STICKY FOOTER ACTIONS ========================== -->
        <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40 safe-area-bottom">
            <div class="max-w-5xl mx-auto flex justify-between items-center gap-4">

                <!-- Prev Button -->
                <button type="button" id="prevBtn" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed hidden">
                    {% translate "Înapoi" %}
                </button>

                <!-- Center: Preview Button -->
                {% if object %}
                <button type="button" id="live-preview-button" class="text-indigo-600 font-medium text-sm flex flex-col items-center justify-center p-2 rounded hover:bg-indigo-50">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <span>Preview</span>
                </button>
                {% endif %}

                <!-- Next / Save Button -->
                <button type="button" id="nextBtn" class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-indigo-700 transition-colors flex items-center justify-center">
                    {% translate "Înainte" %}
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>

                <button type="submit" id="submitBtn" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-green-700 transition-colors hidden items-center justify-center">
                    {% translate "Salvează" %}
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>

            </div>
        </div>

    </form>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 z-[9999] hidden flex items-center justify-center">
    <div id="modal-overlay" class="absolute inset-0 bg-gray-900/90 backdrop-blur-sm transition-opacity"></div>

    <div class="relative bg-white dark:bg-gray-800 w-full h-full md:h-[90vh] md:w-[90vw] md:max-w-6xl md:rounded-2xl shadow-2xl flex flex-col overflow-hidden transition-transform transform scale-100">

        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                Live Preview
            </h3>

            <div class="flex items-center gap-2">
                <button type="button" id="open-new-window-btn" class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors" title="Deschide în fereastră nouă">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    <span class="hidden sm:inline">Deschide Separat</span>
                </button>

                <div class="h-6 w-px bg-gray-300 mx-1"></div>

                <button type="button" id="close-preview-button" class="text-gray-500 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-all focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>

        <div class="flex-1 bg-gray-100 dark:bg-gray-900 relative w-full h-full">
            <iframe id="preview-iframe" class="w-full h-full border-0 block" title="Invitation Preview"></iframe>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- WIZARD LOGIC ---
        let currentStep = 1;
        const totalSteps = 5;
        const form = document.getElementById('event-form');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const progressBar = document.getElementById('progress-bar');
        const stepLabel = document.getElementById('current-step-label');
        const stepIndicators = document.querySelectorAll('.step-indicator');

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.remove('active');
                if(parseInt(el.dataset.step) === step) {
                    el.classList.add('active');
                }
            });

            // Update Buttons
            if (step === 1) {
                prevBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
            }

            if (step === totalSteps) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                submitBtn.style.display = 'flex';
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }

            // Update Progress
            const percentage = (step / totalSteps) * 100;
            progressBar.style.width = percentage + '%';
            stepLabel.innerText = step;

            // Highlight Step Labels
            stepIndicators.forEach((lbl, idx) => {
                if (idx + 1 === step) lbl.classList.add('text-indigo-600', 'font-bold');
                else lbl.classList.remove('text-indigo-600', 'font-bold');
            });

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        nextBtn.addEventListener('click', function() {
            // Validare simplă HTML5 pentru pasul curent
            const currentStepEl = document.querySelector(`.step-content[data-step="${currentStep}"]`);
            const inputs = currentStepEl.querySelectorAll('input[required], select[required], textarea[required]');
            let valid = true;
            inputs.forEach(input => {
                if (!input.checkValidity()) {
                    input.reportValidity();
                    valid = false;
                }
            });

            if(valid) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    showStep(currentStep);
                }
            }
        });

        prevBtn.addEventListener('click', function() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        });

        // --- FORMSET LOGIC (Dynamic Add/Remove) ---
        function setupFormset(prefix) {
            const containerId = `${prefix}-formset-container`;
            const container = document.getElementById(containerId);
            if (!container) return;

            const addButton = document.getElementById(`add-${prefix}-btn`);
            const totalForms = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
            const emptyFormTemplate = document.getElementById(`empty-${prefix}-form`).innerHTML;

            // Delete Buttons Logic (Event Delegation)
            container.addEventListener('click', function(e) {
                const btn = e.target.closest('.delete-form-btn');
                if (!btn) return;

                const formRow = btn.closest(`.${prefix}-form`);
                // Căutăm câmpul hidden DELETE generat de Django
                const deleteInput = formRow.querySelector('input[name$="-DELETE"]');

                if (deleteInput) {
                    // Dacă e formular existent, bifăm DELETE și ascundem
                    deleteInput.checked = true;
                    formRow.style.display = 'none';
                } else {
                    // Dacă e formular nou dinamic, îl ștergem din DOM
                    formRow.remove();
                    let count = parseInt(totalForms.value);
                    totalForms.value = count - 1;
                }
            });

            // Add Button Logic
            if(addButton){
                addButton.addEventListener('click', function() {
                    const count = parseInt(totalForms.value);
                    const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, count);

                    const div = document.createElement('div');
                    div.innerHTML = newFormHtml;

                    container.appendChild(div.firstElementChild);
                    totalForms.value = count + 1;
                });
            }
        }

        // Initialize Formsets (Numele trebuie să coincidă cu contextul din views.py)
        setupFormset('godparents');
        setupFormset('schedule_items');

        // --- CONDITIONAL LOGIC (Filtering Designs & Fields) ---
        const eventTypeInput = document.getElementById('id_event_type');
        const brideContainer = document.getElementById('field-bride_name-container');
        const groomContainer = document.getElementById('field-groom_name-container');
        const childContainer = document.getElementById('field-child_name-container');
        const designOptions = document.querySelectorAll('.design-wrapper');

        function updateFormVisibility() {
            const val = eventTypeInput.value.toLowerCase();

            // 1. Ascunde/Arată câmpuri specifice
            if (val.includes('botez') || val === 'baptism') {
                if(brideContainer) brideContainer.classList.add('hidden');
                if(groomContainer) groomContainer.classList.add('hidden');
                if(childContainer) childContainer.classList.remove('hidden');
            } else {
                if(brideContainer) brideContainer.classList.remove('hidden');
                if(groomContainer) groomContainer.classList.remove('hidden');
                if(childContainer) childContainer.classList.add('hidden');
            }

            // 2. Filtrare Design-uri în funcție de tip
            designOptions.forEach(opt => {
                const designType = opt.dataset.eventType;
                // Logica de potrivire (conține string-ul tipului)
                if (designType.includes(val) || val === '') {
                    opt.style.display = 'block';
                } else {
                    opt.style.display = 'none';
                }
            });
        }

        if(eventTypeInput) {
            eventTypeInput.addEventListener('change', updateFormVisibility);
            updateFormVisibility(); // Inițializare la load
        }

// --- LIVE PREVIEW SCRIPT FINAL ---
    const previewBtn = document.getElementById('live-preview-button');
    const previewModal = document.getElementById('preview-modal');
    const closePreviewBtn = document.getElementById('close-preview-button');
    const modalOverlay = document.getElementById('modal-overlay');
    const newWindowBtn = document.getElementById('open-new-window-btn');
    const previewIframe = document.getElementById('preview-iframe');
    // Luăm token-ul CSRF defensiv (dacă există)
    const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfToken = csrfElement ? csrfElement.value : '';

    // Funcții Modal
    function openModal() {
        if(previewModal) {
            previewModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Blochează scroll spate
        }
    }

    function closeModal() {
        if(previewModal) {
            previewModal.classList.add('hidden');
            document.body.style.overflow = '';
            if(previewIframe) previewIframe.srcdoc = ''; // Resetăm conținutul
        }
    }

    // --- LOGICA PRINCIPALĂ ---
    if (previewBtn) {
        previewBtn.addEventListener('click', async function(e) {
            e.preventDefault();

            // 1. UI Feedback
            const originalBtnContent = previewBtn.innerHTML;
            previewBtn.innerHTML = '<span class="animate-spin inline-block mr-2">↻</span> Generare...';
            previewBtn.disabled = true;

            const formData = {};
            const formElements = document.getElementById('event-form').elements;
            const promises = [];
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // Mărim limita la 10MB (pt video/audio)

            // Funcție Helper citire fișier
            const readFileAsDataURL = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            // 2. Procesare Formular
            for (const element of formElements) {
                if (!element.name) continue;

                if (element.type === 'file') {
                    // CAZUL A: UPLOAD NOU (Userul a ales un fișier acum)
                    if (element.files && element.files.length > 0) {
                        const file = element.files[0];
                        if (file.size > MAX_FILE_SIZE) {
                            alert(`Fișierul ${file.name} este prea mare (Max 10MB).`);
                            previewBtn.innerHTML = originalBtnContent;
                            previewBtn.disabled = false;
                            return;
                        }
                        // Transformăm în Base64 (Imagine, Audio sau Video)
                        promises.push(readFileAsDataURL(file).then(data => formData[element.name] = data));
                    }
                    // CAZUL B: FIȘIER EXISTENT (Userul NU a schimbat fișierul)
                    // --- AICI ESTE FIX-UL SPECIALISTULUI ---
                    else {
                        const container = element.closest('div');
                        const existingLink = container ? container.querySelector('a[href*="/media/"]') : null;

                        if (existingLink) {
                            // Luăm calea din href (ex: /media/event_photos/poza.jpg)
                            let rawPath = existingLink.getAttribute('href');

                            // 1. Curățăm prefixul "/media/" pentru a nu-l dubla în Django
                            // Rezultat: "event_photos/poza.jpg"
                            if (rawPath.startsWith('/media/')) {
                                rawPath = rawPath.replace('/media/', '');
                            }

                            // 2. Curățăm și slash-ul de început dacă a mai rămas
                            if (rawPath.startsWith('/')) {
                                rawPath = rawPath.substring(1);
                            }

                            formData[element.name] = rawPath;
                        }
                    }
                }
                else if (element.type === 'radio') {
                    if (element.checked) formData[element.name] = element.value;
                }
                else {
                    formData[element.name] = element.value;
                }
            }

            await Promise.all(promises);

            // 3. Trimitere către Django
            try {
                const response = await fetch("{% url 'invapp:event_preview' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('Network error');

                const htmlContent = await response.text();

                // 4. Afișare
                if(previewIframe) {
                    previewIframe.srcdoc = htmlContent;
                    openModal();
                }

            } catch (error) {
                console.error(error);
                alert('Eroare la generare. Verifică consola.');
            } finally {
                previewBtn.innerHTML = originalBtnContent;
                previewBtn.disabled = false;
            }
        });
    }

    // Evenimente Închidere
    if (closePreviewBtn) closePreviewBtn.addEventListener('click', closeModal);
    if (modalOverlay) modalOverlay.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && previewModal && !previewModal.classList.contains('hidden')) {
            closeModal();
        }
    });

    // Eveniment Deschidere Tab Nou
    if (newWindowBtn) {
        newWindowBtn.addEventListener('click', () => {
            const content = previewIframe.srcdoc;
            if (!content) return alert("Generează întâi preview-ul!");

            const newWin = window.open('', '_blank');
            if (newWin) {
                newWin.document.write(content);
                newWin.document.close();
            } else {
                alert("Browserul a blocat fereastra nouă.");
            }
        });
    }
    });
</script>
{% endblock %}
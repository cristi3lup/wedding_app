{% extends "invapp/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}
    {% if object %}
        {% translate "Edit Event:" %} {{ object.title }}
    {% else %}
        {% translate "Create New Event" %}
    {% endif %}
{% endblock %}

<!-- Custom Navigation for This Page -->
{% block nav_links %}
    <a href="{% url 'invapp:dashboard' %}" class="border-transparent text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">{% translate "Dashboard" %}</a>
    {% if object %}
        <a href="{% url 'invapp:guest_list' event_id=object.id %}" class="border-transparent text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">{% translate "Guest List" %}</a>
        <a href="{% url 'invapp:table_assignment_ui' event_id=object.id %}" class="border-transparent text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">{% translate "Assign Guests" %}</a>
    {% endif %}
{% endblock nav_links %}

{% block mobile_nav_links %}
    <a href="{% url 'invapp:dashboard' %}" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">{% translate "Dashboard" %}</a>
    {% if object %}
        <a href="{% url 'invapp:guest_list' event_id=object.id %}" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">{% translate "Guest List" %}</a>
        <a href="{% url 'invapp:table_assignment_ui' event_id=object.id %}" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">{% translate "Assign Guests" %}</a>
    {% endif %}
{% endblock mobile_nav_links %}


{% block page_header %}
    <div class="sm:flex sm:justify-between sm:items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">
                {% if object %}
                    {% translate "Edit Event" %}
                {% else %}
                    {% translate "Create New Event" %}
                {% endif %}
            </h1>
            {% if object %}
                <p class="mt-1 text-md text-gray-600 dark:text-gray-400">
                    {% translate "Editing:" %} <strong class="font-semibold">{{ object.title }}</strong>
                </p>
            {% endif %}
        </div>
        <div class="mt-4 sm:mt-0">
            <a href="{% url 'invapp:dashboard' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                {% translate "Back to Dashboard" %}
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
    {% if is_locked_plan %}
    <div class="mb-6 rounded-md bg-yellow-50 dark:bg-yellow-900/50 p-4 border-l-4 border-yellow-400">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700 dark:text-yellow-300">
                    {% translate "Your plan locks core event details." %}
                    <a href="{% url 'invapp:landing_page' %}#pricing" class="font-medium underline hover:text-yellow-600 dark:hover:text-yellow-200">
                        {% translate "Upgrade your plan" %}
                    </a>
                    {% translate "to unlock all fields, including event type, date, and design." %}
                </p>
                <p class="mt-2 text-sm text-yellow-700 dark:text-yellow-300 font-medium">
                    {% translate "Need to update the date or time? Please contact the administrator. Provide your user email and the event name, and we will update it for you." %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <form id="event-form" method="POST" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}

            <!-- NEW: Display non-field errors -->
            {% if form.non_field_errors %}
                <div class="rounded-md bg-red-50 dark:bg-red-900/50 p-4">
                    <div class="flex">
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800 dark:text-red-300">{% translate "Please correct the errors below:" %}</h3>
                            <div class="mt-2 text-sm text-red-700 dark:text-red-400">
                                <ul role="list" class="list-disc space-y-1 pl-5">
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Event Type & Design Card -->
            <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-3">{% translate "Event Type & Design" %}</h3>
                <div class="mt-6 space-y-6">
                    <div>
                        <!-- FIX: Error Styling for Event Type -->
                        <label for="{{ form.event_type.id_for_label }}" class="block text-sm font-medium {% if form.event_type.errors %}text-red-700 dark:text-red-400{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                            {{ form.event_type.label }}
                            {% if form.event_type.field.required %}<span class="text-red-500">*</span>{% endif %}

                            <!-- Locked Badge -->
                            {% if is_locked_plan %}
                                <span class="ml-2 inline-flex items-center rounded-md bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-800 ring-1 ring-inset ring-yellow-600/20">
                                    <svg class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                                    {% translate "Locked" %}
                                </span>
                            {% endif %}
                        </label>
                        <div class="mt-1">
                            {{ form.event_type }}
                            <!-- FIX FOR LOCKED PLAN: Send hidden value so validation passes -->
                            {% if is_locked_plan %}
                                <input type="hidden" name="event_type" value="{{ form.instance.event_type }}">
                            {% endif %}
                        </div>
                        <!-- FIX: Display errors -->
                        {% if form.event_type.errors %}
                            <p class="mt-2 text-sm text-red-600 dark:text-red-400">
                                {{ form.event_type.errors|striptags }}
                            </p>
                        {% endif %}
                    </div>
                    <div class="hidden">{{ form.selected_design }}</div>

                    <div id="design-selection-container" class="conditional-section">
                        <!-- FIX: Error Styling for Design -->
                        <label class="block text-sm font-medium {% if form.selected_design.errors %}text-red-700 dark:text-red-400{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                            {% translate "Select a Design" %}
                            <span class="text-red-500">*</span>
                            {% if is_locked_plan %}
                                <span class="ml-2 inline-flex items-center rounded-md bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-800 ring-1 ring-inset ring-yellow-600/20">
                                    <svg class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                                    {% translate "Locked" %}
                                </span>
                            {% endif %}
                        </label>

                        <!-- FIX FOR LOCKED PLAN: Add opacity and disable interactions if locked -->
                        <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4 {% if is_locked_plan %}opacity-60 pointer-events-none{% endif %}">
                            {% for design in available_designs %}
                                <div class="design-wrapper" data-event-type="{{ design.event_type|lower|slugify }}" style="display: none;">
                                    <label for="design_{{ design.id }}" class="relative block rounded-lg border bg-gray-50 dark:bg-gray-700/50 p-3 shadow-sm cursor-pointer has-[:checked]:border-indigo-500 has-[:checked]:ring-2 has-[:checked]:ring-indigo-500">
                                        <input type="radio" name="selected_design" id="design_{{ design.id }}" value="{{ design.id }}" class="sr-only design-radio" data-design-name="{{ design.name|slugify }}" {% if form.instance.selected_design.id == design.id %} checked {% endif %} {% if is_locked_plan %}disabled{% endif %}>
                                        <span class="flex flex-col items-center text-center">
                                            {% if design.preview_image_path %}<img src="{% static design.preview_image_path %}" alt="{{ design.name }} preview" class="h-40 w-full object-cover rounded-md mb-2">{% else %}<div class="h-40 w-full bg-gray-200 dark:bg-gray-600 rounded-md mb-2 flex items-center justify-center"><span class="text-xs text-gray-400">{% translate "No Preview" %}</span></div>{% endif %}
                                            <span class="block text-sm font-medium text-gray-900 dark:text-gray-100">{{ design.name }}</span>
                                        </span>
                                    </label>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- FIX: Display errors -->
                        {% if form.selected_design.errors %}
                            <p class="mt-2 text-sm text-red-600 dark:text-red-400">
                                {{ form.selected_design.errors|striptags }}
                            </p>
                        {% endif %}

                        <!-- FIX FOR LOCKED PLAN: Send hidden design ID -->
                        {% if is_locked_plan %}
                            <input type="hidden" name="selected_design" value="{{ form.instance.selected_design.id }}">
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Wrapper for all conditional form sections -->
            <div id="form-fields-wrapper" class="space-y-8 conditional-field">

                <!-- Event Details Card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-3">{% translate "Event Details" %}</h3>
                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div id="field-title-container" class="field-container conditional-field sm:col-span-2"></div>
                        <!-- UPDATED: Replaced date_time with event_date -->
                        <div id="field-event_date-container" class="field-container conditional-field"></div>
                        <div id="field-bride_name-container" class="field-container conditional-field"></div>
                        <div id="field-groom_name-container" class="field-container conditional-field"></div>
                        <div id="field-bride_parents-container" class="field-container conditional-field"></div>
                        <div id="field-groom_parents-container" class="field-container conditional-field"></div>
                        <div id="field-child_name-container" class="field-container conditional-field"></div>
                        <div id="field-parents_names-container" class="field-container conditional-field"></div>
                    </div>
                </div>

                 <!-- ============================================== -->
                <!-- === 1. Godparents Formset Card (with ID)   === -->
                <!-- ============================================== -->
                <div id="godparents-section" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-3">
                        {% translate "Godparents" %}
                    </h3>
                    <div id="godparent-formset" class="mt-6 space-y-4">
                        {{ godparent_formset.management_form }}
                        {% for form in godparent_formset %}
                            <div class="godparent-form flex items-center space-x-4">
                                <div class="flex-grow">
                                    <!-- This renders the text input for the godparent's name -->
                                    {{ form.name }}
                                    <!-- These are hidden fields Django needs to manage the form -->
                                    {{ form.id }}
                                    {% if form.name.errors %}
                                        <p class="text-xs text-red-600 mt-1">{{ form.name.errors|striptags }}</p>
                                    {% endif %}
                                </div>
                                <!-- This shows the 'Delete' checkbox only for existing godparents -->
                                <div class="hidden">{{ form.DELETE }}</div>
                                <button type="button" class="delete-godparent-btn p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <span class="sr-only">{% translate "Delete" %}</span>
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.84.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                    <!-- This is the button that will add a new form row via JavaScript -->
                    <div class="mt-4">
                        <button type="button" id="add-godparent-form" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                            + {% translate "Add another Godparent" %}
                        </button>
                    </div>
                </div>

                <!-- Location & Timing Card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                     <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-3">{% translate "Location & Timing" %}</h3>
                     <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div id="field-venue_name-container" class="field-container conditional-field"></div>
                        <div id="field-venue_address-container" class="field-container conditional-field"></div>
                        <!-- UPDATED: Added party_time container -->
                        <div id="field-party_time-container" class="field-container conditional-field"></div>
                        <div id="field-ceremony_time-container" class="field-container conditional-field"></div>
                        <div id="field-ceremony_location-container" class="field-container conditional-field"></div>
                        <div id="field-ceremony_maps_url-container" class="field-container conditional-field sm:col-span-2"></div>
                        <div id="field-party_maps_url-container" class="field-container conditional-field sm:col-span-2"></div>
                        <div id="field-Maps_embed_url-container" class="field-container conditional-field sm:col-span-2"></div>
                     </div>
                </div>

                <!-- ============================================== -->
                <!-- === NEW: Schedule Items Formset Card       === -->
                <!-- ============================================== -->
                <!-- UPDATED: Changed ID and added classes to work as a Special Field -->
                <div id="field-schedule_items-container" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 field-container" style="display: none;">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-3">
                        {% translate "Event Schedule / Timeline" %}
                    </h3>
                    <div id="schedule-item-formset" class="mt-6 space-y-6">
                        {{ schedule_item_formset.management_form }}
                        {% for form in schedule_item_formset %}
                            <div class="schedule-item-form border border-gray-200 dark:border-gray-700 rounded-md p-4 relative">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <!-- Activity Type -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 uppercase">{{ form.activity_type.label }}</label>
                                        {{ form.activity_type }}
                                    </div>
                                    <!-- Time -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 uppercase">{{ form.time.label }}</label>
                                        {{ form.time }}
                                    </div>
                                    <!-- Location -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 uppercase">{{ form.location.label }}</label>
                                        {{ form.location }}
                                    </div>
                                    <!-- Description -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 uppercase">{{ form.description.label }}</label>
                                        {{ form.description }}
                                    </div>
                                </div>

                                <!-- Hidden ID -->
                                {{ form.id }}

                                <!-- Delete Button -->
                                <div class="hidden">{{ form.DELETE }}</div>
                                <button type="button" class="delete-schedule-btn absolute top-2 right-2 text-gray-400 hover:text-red-600">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="mt-4">
                        <button type="button" id="add-schedule-item" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                            + {% translate "Add Schedule Item" %}
                        </button>
                    </div>
                </div>

                <!-- Invitation Content Card -->
                 <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                     <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-3">{% translate "Invitation Content" %}</h3>
                     <div class="mt-6 grid grid-cols-1 gap-6">
                        <div id="field-invitation_wording-container" class="field-container conditional-field"></div>
                        <div id="field-schedule_details-container" class="field-container conditional-field"></div>
                        <div id="field-other_info-container" class="field-container conditional-field"></div>
                        <div id="field-calendar_description-container" class="field-container conditional-field"></div>
                     </div>
                </div>

                <!-- Media & Photos Card -->
                 <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                     <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-3">{% translate "Media & Photos" %}</h3>
                     <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div id="field-couple_photo-container" class="field-container conditional-field"></div>
                        <div id="field-landscape_photo-container" class="field-container conditional-field"></div>
                        <div id="field-main_invitation_image-container" class="field-container conditional-field sm:col-span-2"></div>
                        <div id="field-audio_greeting-container" class="field-container conditional-field sm:col-span-2"></div>
                     </div>
                </div>

            <!-- This is a hidden div to hold all the form fields for easy manipulation by JS -->
            <div id="field-source" style="display: none;">
                {% for field in form %}
                    {% if field.name != 'selected_design' and field.name != 'event_type' %}
                        <div id="source-field-{{ field.name }}-container">
                            <!-- FIX: Error Styling for Dynamic Fields -->
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium {% if field.errors %}text-red-700 dark:text-red-400{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                                {{ field.label }}

                                <!-- Mandatory Asterisk -->
                                {% if field.field.required %}
                                    <span class="text-red-500">*</span>
                                {% endif %}

                                <!-- FIX FOR LOCKED PLAN: Add locked badge to event_date ONLY (removed party_time) -->
                                {% if is_locked_plan and field.name == 'event_date' %}
                                    <span class="ml-2 inline-flex items-center rounded-md bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-800 ring-1 ring-inset ring-yellow-600/20">
                                        <svg class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                                        {% translate "Locked" %}
                                    </span>
                                {% endif %}
                            </label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                {% if field.name == 'title' or field.name == 'venue_name' or field.name == 'ceremony_location' %}
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.243 3.03a1 1 0 01.727 1.213L9.53 6h1.214a1 1 0 110 2H9.53l-.44 1.76a1 1 0 11-1.94.486L7.53 8H6.316a1 1 0 110-2h1.214l.44-1.76a1 1 0 011.213-.727zM12 8a1 1 0 100-2h1.214l.44-1.76a1 1 0 111.94.486L15.145 6H16.36a1 1 0 110 2h-1.214l-.44 1.76a1 1 0 11-1.94-.486L13.145 8H12z" clip-rule="evenodd" /></svg>
                                    </div>
                                {% elif field.name == 'event_date' %}
                                     <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                    </div>
                                {% elif field.name == 'ceremony_time' or field.name == 'party_time' %}
                                     <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                                    </div>
                                {% endif %}
                                {{ field }}

                                <!-- FIX FOR LOCKED PLAN: Send hidden value for event_date if locked (removed party_time) -->
                                {% if is_locked_plan and field.name == 'event_date' %}
                                    <input type="hidden" name="{{ field.name }}" value="{{ field.value|date:'Y-m-d' }}">
                                {% endif %}
                            </div>

                            <!-- FIX: Display Field Errors -->
                            {% if field.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">
                                    {{ field.errors|striptags }}
                                </p>
                            {% endif %}

                            {% if field.help_text %}<p class="mt-2 text-xs text-gray-500 dark:text-gray-400">{{ field.help_text }}</p>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="pt-5 flex flex-col sm:flex-row-reverse gap-3 conditional-field">
                <button type="submit" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">
                    {% if object %}
                        {% translate "Save Changes" %}
                    {% else %}
                        {% translate "Create Event" %}
                    {% endif %}
                </button>
                <button type="button" id="live-preview-button" disabled class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50">
                    {% translate "Live Preview" %}
                </button>
            </div>
        </form>
    </div>

    <!-- Hidden template for new forms -->
    <div id="empty-godparent-form" style="display: none;">
        <div class="godparent-form flex items-center space-x-4">
            <div class="flex-grow">
                {{ godparent_formset.empty_form.name }}
            </div>
            <div class="hidden">{{ godparent_formset.empty_form.DELETE }}</div>
            <button type="button" class="delete-godparent-btn p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                <span class="sr-only">{% translate "Remove" %}</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.84.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
            </button>
        </div>
    </div>

    <!-- Hidden Template for New Schedule Items -->
    <div id="empty-schedule-form" style="display: none;">
        <div class="schedule-item-form border border-gray-200 dark:border-gray-700 rounded-md p-4 relative mt-4">
             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div><label class="block text-xs font-medium text-gray-500 uppercase">{{ schedule_item_formset.empty_form.activity_type.label }}</label>{{ schedule_item_formset.empty_form.activity_type }}</div>
                <div><label class="block text-xs font-medium text-gray-500 uppercase">{{ schedule_item_formset.empty_form.time.label }}</label>{{ schedule_item_formset.empty_form.time }}</div>
                <div><label class="block text-xs font-medium text-gray-500 uppercase">{{ schedule_item_formset.empty_form.location.label }}</label>{{ schedule_item_formset.empty_form.location }}</div>
                <div><label class="block text-xs font-medium text-gray-500 uppercase">{{ schedule_item_formset.empty_form.description.label }}</label>{{ schedule_item_formset.empty_form.description }}</div>
            </div>
            <div class="hidden">{{ schedule_item_formset.empty_form.DELETE }}</div>
            <button type="button" class="delete-schedule-btn absolute top-2 right-2 text-gray-400 hover:text-red-600">
                 <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>
    </div>

    <!-- Preview Modal HTML -->
    <div id="preview-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 p-4 sm:p-8" style="display: none;">
        <div class="bg-white dark:bg-gray-800 w-full h-full max-w-4xl mx-auto rounded-lg shadow-2xl flex flex-col">
            <div class="flex-shrink-0 p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">{% translate "Invitation Preview" %}</h3>
                <button id="close-preview-button" class="text-gray-400 hover:text-gray-600 dark:text-gray-300 dark:hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto">
                <iframe id="preview-iframe" class="w-full h-full border-0"></iframe>
            </div>
        </div>
    </div>
{% endblock %}


{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Move all form fields from the hidden source to their new card locations ---
        const fieldSource = document.getElementById('field-source');
        if (fieldSource) {
            const allFields = fieldSource.querySelectorAll('[id^="source-field-"]');
            allFields.forEach(sourceContainer => {
                const fieldName = sourceContainer.id.replace('source-field-', '').replace('-container', '');
                const targetContainer = document.getElementById('field-' + fieldName + '-container');
                if (targetContainer) {
                    while(sourceContainer.firstChild) {
                        targetContainer.appendChild(sourceContainer.firstChild);
                    }
                }
            });
            fieldSource.remove();
        }

        const eventTypeSelect = document.getElementById('id_event_type');
        const designRadios = document.querySelectorAll('.design-radio');
        const designSpecificFields = {{ design_specific_fields_json|safe }};
        const fieldGroups = {
            // UPDATED: Used event_date and added party_time
            wedding: ['title', 'event_date', 'party_time', 'bride_name', 'groom_name', 'bride_parents', 'groom_parents', 'godparents_names', 'venue_name', 'venue_address', 'ceremony_time', 'ceremony_location', 'ceremony_maps_url', 'party_maps_url', 'invitation_wording', 'schedule_details', 'other_info', 'calendar_description'],
            baptism: ['title', 'event_date', 'party_time', 'child_name', 'parents_names', 'godparents_names', 'venue_name', 'venue_address', 'ceremony_time', 'ceremony_location', 'ceremony_maps_url', 'party_maps_url', 'invitation_wording', 'calendar_description'],
            image_upload: ['title', 'event_date', 'Maps_embed_url', 'main_invitation_image']
        };

        function updateFormVisibility() {
            const selectedType = eventTypeSelect.value ? eventTypeSelect.value.toLowerCase().replace(' ', '_') : '';
            const selectedDesignRadio = document.querySelector('.design-radio:checked');
            const selectedDesignName = selectedDesignRadio ? selectedDesignRadio.dataset.designName : null;

            document.querySelectorAll('.conditional-section, .conditional-field, .field-container').forEach(el => el.style.display = 'none');
            document.getElementById('live-preview-button').disabled = true;

            // NEW: Handle Godparents Section Visibility
            const godparentsSection = document.getElementById('godparents-section');
            if (godparentsSection) {
                // Only show godparents for Wedding or Baptism
                if (['wedding', 'baptism'].includes(selectedType)) {
                    godparentsSection.style.display = 'block';
                } else {
                    godparentsSection.style.display = 'none';
                }
            }

            const designSelectionContainer = document.getElementById('design-selection-container');
            if (selectedType) {
                designSelectionContainer.style.display = 'block';
                document.querySelectorAll('.design-wrapper').forEach(wrapper => {
                    wrapper.style.display = (wrapper.dataset.eventType === selectedType) ? 'block' : 'none';
                });
            }

            if (selectedDesignRadio) {
                document.getElementById('live-preview-button').disabled = false;
                document.getElementById('form-fields-wrapper').style.display = 'block';

                if (fieldGroups[selectedType]) {
                    fieldGroups[selectedType].forEach(fieldName => {
                        const fieldContainer = document.getElementById('field-' + fieldName + '-container');
                        if (fieldContainer) fieldContainer.style.display = 'block';
                    });
                }

                if (selectedDesignName && designSpecificFields[selectedDesignName]) {
                    const specialFieldsForDesign = designSpecificFields[selectedDesignName];
                    specialFieldsForDesign.forEach(fieldName => {
                        const fieldContainer = document.getElementById('field-' + fieldName + '-container');
                        if (fieldContainer) fieldContainer.style.display = 'block';
                    });
                }
                document.querySelector('.pt-5.conditional-field').style.display = 'flex';
            }
        }

        // --- UPDATED: JavaScript for managing the Godparent formset ---
        const addGodparentBtn = document.getElementById('add-godparent-form');
        const godparentFormset = document.getElementById('godparent-formset');
        const emptyFormTemplate = document.getElementById('empty-godparent-form').innerHTML;
        const totalFormsInput = document.querySelector('input[name="godparents-TOTAL_FORMS"]');

        if(addGodparentBtn){
            addGodparentBtn.addEventListener('click', function() {
                let formNum = parseInt(totalFormsInput.value);
                const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formNum);

                const newFormDiv = document.createElement('div');
                newFormDiv.innerHTML = newFormHtml;
                // The new form is already wrapped in the correct div from the template
                const formContainer = newFormDiv.querySelector('.godparent-form');
                godparentFormset.appendChild(formContainer);

                totalFormsInput.value = formNum + 1;
            });
        }

        // --- NEW: Event delegation for handling delete clicks ---
        if(godparentFormset){
             godparentFormset.addEventListener('click', function(event) {
                const deleteButton = event.target.closest('.delete-godparent-btn');
                if (!deleteButton) return;

                const formContainer = deleteButton.closest('.godparent-form');
                if (!formContainer) return;

                // Find the hidden DELETE checkbox within this form row
                const deleteInput = formContainer.querySelector('input[id$="-DELETE"]');

                if (deleteInput) {
                    // This is an existing form. Check the box and hide the row.
                    deleteInput.checked = true;
                    formContainer.style.display = 'none';
                } else {
                    // This is a new, unsaved form. Just remove it from the page.
                    formContainer.remove();
                }
            });
        }

        // --- Schedule Item Formset Logic ---
        const addScheduleBtn = document.getElementById('add-schedule-item');
        const scheduleFormset = document.getElementById('schedule-item-formset');
        const emptyScheduleTemplate = document.getElementById('empty-schedule-form').innerHTML;
        const totalScheduleFormsInput = document.querySelector('input[name="schedule_items-TOTAL_FORMS"]');

        if(addScheduleBtn){
            addScheduleBtn.addEventListener('click', function() {
                let formNum = parseInt(totalScheduleFormsInput.value);
                const newFormHtml = emptyScheduleTemplate.replace(/__prefix__/g, formNum);
                const newFormDiv = document.createElement('div');
                newFormDiv.innerHTML = newFormHtml;
                scheduleFormset.appendChild(newFormDiv.firstElementChild);
                totalScheduleFormsInput.value = formNum + 1;
            });
        }

        if(scheduleFormset){
             scheduleFormset.addEventListener('click', function(event) {
                const deleteButton = event.target.closest('.delete-schedule-btn');
                if (!deleteButton) return;
                const formContainer = deleteButton.closest('.schedule-item-form');
                const deleteInput = formContainer.querySelector('input[id$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                    formContainer.style.display = 'none';
                } else {
                    formContainer.remove();
                }
            });
        }

        // --- Add padding to inputs that have an icon ---
        // UPDATED: Use event_date and party_time instead of date_time
        const fieldsWithIcons = ['title', 'event_date', 'party_time', 'venue_name', 'ceremony_location', 'ceremony_time'];
        fieldsWithIcons.forEach(fieldName => {
            const fieldContainer = document.getElementById('field-' + fieldName + '-container');
            if (fieldContainer) {
                const input = fieldContainer.querySelector('input, textarea');
                if (input) {
                    input.classList.add('pl-10');
                }
            }
        });

        // --- LIVE PREVIEW FUNCTIONS ---
        const form = document.getElementById('event-form');
        const previewUrl = "{% url 'invapp:event_preview' %}";
        const previewModal = document.getElementById('preview-modal');
        const closePreviewButton = document.getElementById('close-preview-button');
        const previewIframe = document.getElementById('preview-iframe');

        async function handlePreview(event) {
            event.preventDefault();
            const formData = {};
            const formElements = form.elements;
            const promises = [];
            const MAX_FILE_SIZE_MB = 2.5;
            const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
            const readFileAsDataURL = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };
            for (const element of formElements) {
                if (!element.name) continue;
                if (element.type === 'file') {
                    if (element.files && element.files.length > 0) {
                        const file = element.files[0];
                        if (file.size > MAX_FILE_SIZE_BYTES) {
                            alert('{% translate "File is too large! Please upload a file smaller than 2.5 MB." %}');
                            return;
                        }
                        const promise = readFileAsDataURL(file).then(dataUrl => { formData[element.name] = dataUrl; });
                        promises.push(promise);
                    } else {
                        const container = element.closest('.field-container');
                        if(container){
                            const existingImageLink = container.querySelector('a[href*="/media/"]');
                            if (existingImageLink) { formData[element.name] = existingImageLink.textContent; }
                        }
                    }
                } else if (element.type === 'radio') {
                    if (element.checked) formData[element.name] = element.value;
                } else {
                    formData[element.name] = element.value;
                }
            }
            await Promise.all(promises);
            try {
                const response = await fetch(previewUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value },
                    body: JSON.stringify(formData)
                });
                if (!response.ok) throw new Error(`Preview failed: ${response.statusText}`);
                const htmlPreview = await response.text();
                previewIframe.srcdoc = htmlPreview;
                previewModal.style.display = 'flex';
            } catch (error) {
                console.error('Error fetching preview:', error);
                alert('{% translate "Could not generate a preview. Please check the developer console." %}');
            }
        }
        function closeModal() {
            previewModal.style.display = 'none';
            previewIframe.srcdoc = '';
        }

        // Event Listeners
        if(eventTypeSelect) eventTypeSelect.addEventListener('change', updateFormVisibility);
        designRadios.forEach(radio => radio.addEventListener('change', updateFormVisibility));
        if(document.getElementById('live-preview-button')) document.getElementById('live-preview-button').addEventListener('click', handlePreview);
        if(closePreviewButton) closePreviewButton.addEventListener('click', closeModal);
        if(previewModal) previewModal.addEventListener('click', function(event) {
            if (event.target === previewModal) { closeModal(); }
        });

        updateFormVisibility();
    });
</script>
{% endblock %}
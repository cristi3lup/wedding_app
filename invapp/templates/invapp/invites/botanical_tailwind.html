{% extends "invapp/base_invite.html" %}
{% load static %}
{% load i18n %}

{% block page_specific_fonts %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}

{% block page_specific_styles %}
<style>
    body {
        font-family: 'Montserrat', sans-serif;
        background-color: #F3F0EB; /* Warmer beige/stone */
        color: #4A4A4A;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
    }
    .font-serif {
        font-family: 'Cormorant Garamond', serif;
    }

    /* Elegant Fade In Animation */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-up {
        animation: fadeInUp 1s ease-out forwards;
    }

    /* Floating Leaves Animation */
    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(2deg); }
    }
    .animate-float {
        animation: float 8s ease-in-out infinite;
    }

    /* Custom Button */
    .btn-botanical {
        background-color: #5D7355; /* Sage Green */
        color: white;
        transition: all 0.3s ease;
    }
    .btn-botanical:hover {
        background-color: #4A5D44;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(93, 115, 85, 0.3);
    }

    .glass-panel {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.6);
    }
</style>
{% endblock %}

{% block content %}
<!-- x-data handles Modal state -->
<div x-data="{ rsvpOpen: false }" class="relative min-h-screen overflow-hidden selection:bg-[#5D7355] selection:text-white">

    <!-- Decorative Background SVGs -->
    <div class="fixed top-0 left-0 w-64 h-64 -translate-x-1/2 -translate-y-1/2 opacity-10 text-[#5D7355] pointer-events-none animate-float">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,22c4.97,0,9-4.03,9-9c0-4.97-9-13-9-13S3,8.03,3,13C3,17.97,7.03,22,12,22z"/></svg>
    </div>
    <div class="fixed bottom-0 right-0 w-96 h-96 translate-x-1/3 translate-y-1/3 opacity-10 text-[#5D7355] pointer-events-none animate-float" style="animation-delay: 1s;">
         <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17,8C8,10,5.9,16.17,3.82,21.34L5.71,22l1.04-3.37c4.8-2.54,12.27-5.92,14.65-11.75L17,8z"/></svg>
    </div>

    <!-- Main Content Container -->
    <div class="max-w-3xl mx-auto py-12 px-4 sm:px-6 relative z-10">

        <!-- Main Card -->
        <div class="glass-panel rounded-2xl shadow-xl overflow-hidden animate-fade-up">

            <!-- Image Header -->
            <div class="relative h-96 bg-stone-200">
                {% if event.couple_photo %}
                    <img src="{{ event.couple_photo.url }}" alt="Couple" class="w-full h-full object-cover">
                {% else %}
                    <div class="w-full h-full flex items-center justify-center text-stone-400 font-serif italic text-2xl bg-[#E8E6E1]">
                        {{ event.bride_name }} & {{ event.groom_name }}
                    </div>
                {% endif %}

                <!-- Date Overlay Badge -->
                <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 bg-white px-8 py-4 shadow-lg rounded-t-lg rounded-b-2xl text-center border-t-4 border-[#5D7355]">
                    <p class="text-xs tracking-[0.2em] uppercase text-stone-500">Save the Date</p>
                    <p class="font-serif text-3xl font-bold text-[#2C2C2C] mt-1">{{ event.event_date|date:"d.m.Y" }}</p>
                </div>
            </div>

            <!-- Content Body -->
            <div class="px-8 pt-16 pb-12 text-center">

                <!-- Monogram -->
                <div class="mb-6 text-[#5D7355]">
                    <i data-lucide="leaf" class="w-8 h-8 mx-auto opacity-80"></i>
                </div>

                <h1 class="font-serif text-5xl sm:text-7xl text-[#2C2C2C] leading-none mb-4">
                    {{ event.bride_name }} <span class="text-[#5D7355] text-4xl align-middle mx-2">&</span> {{ event.groom_name }}
                </h1>

                <p class="text-stone-600 uppercase tracking-widest text-xs mt-6 mb-12 relative inline-block px-6">
                    <span class="absolute left-0 top-1/2 w-4 h-px bg-stone-300"></span>
                    {% translate "Se căsătoresc" %}
                    <span class="absolute right-0 top-1/2 w-4 h-px bg-stone-300"></span>
                </p>

                <!-- Countdown -->
                {% if event.event_date %}
                <div x-data="countdown('{{ event.event_date|date:'Y-m-d' }}T{% if event.party_time %}{{ event.party_time|time:'H:i:s' }}{% else %}00:00:00{% endif %}')"
                     x-init="init()"
                     class="grid grid-cols-4 gap-4 max-w-md mx-auto mb-16 font-serif text-[#5D7355]">
                    <div class="bg-[#F3F0EB] p-3 rounded-lg">
                        <span x-text="time.days" class="block text-3xl font-bold leading-none"></span>
                        <span class="text-[10px] uppercase tracking-wider text-stone-500">{% translate "Zile" %}</span>
                    </div>
                    <div class="bg-[#F3F0EB] p-3 rounded-lg">
                        <span x-text="time.hours" class="block text-3xl font-bold leading-none"></span>
                        <span class="text-[10px] uppercase tracking-wider text-stone-500">{% translate "Ore" %}</span>
                    </div>
                    <div class="bg-[#F3F0EB] p-3 rounded-lg">
                        <span x-text="time.minutes" class="block text-3xl font-bold leading-none"></span>
                        <span class="text-[10px] uppercase tracking-wider text-stone-500">{% translate "Min" %}</span>
                    </div>
                    <div class="bg-[#F3F0EB] p-3 rounded-lg">
                        <span x-text="time.seconds" class="block text-3xl font-bold leading-none"></span>
                        <span class="text-[10px] uppercase tracking-wider text-stone-500">{% translate "Sec" %}</span>
                    </div>
                </div>
                {% endif %}

                <!-- Details Columns -->
                <div class="grid md:grid-cols-2 gap-10 text-left max-w-2xl mx-auto mb-16">
                    <!-- Ceremony -->
                    <div class="relative pl-6 border-l-2 border-[#5D7355]/30">
                        <h3 class="font-serif text-2xl text-[#2C2C2C] mb-1 flex items-center gap-2">
                            <i data-lucide="church" class="w-6 h-6 text-[#5D7355]"></i>
                            {% translate "Cununia" %}
                        </h3>
                        <p class="text-[#5D7355] font-bold text-sm mb-2">{{ event.ceremony_time|time:"H:i" }}</p>
                        <p class="text-stone-600 text-sm leading-relaxed">{{ event.ceremony_location }}</p>
                        {% if event.ceremony_maps_url %}
                            <a href="{{ event.ceremony_maps_url }}" target="_blank" class="inline-flex items-center mt-3 text-xs font-bold text-[#5D7355] hover:underline">
                                <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> {% translate "Adresa" %}
                            </a>
                        {% endif %}
                    </div>

                    <!-- Party -->
                    <div class="relative pl-6 border-l-2 border-[#5D7355]/30">
                        <h3 class="font-serif text-2xl text-[#2C2C2C] mb-1 flex items-center gap-2">
                            <i data-lucide="wine" class="w-6 h-6 text-[#5D7355]"></i>
                            {% translate "Petrecerea" %}
                        </h3>
                        <!-- UPDATED: Use party_time -->
                        <p class="text-[#5D7355] font-bold text-sm mb-2">{{ event.party_time|time:"H:i" }}</p>
                        <p class="text-stone-600 text-sm leading-relaxed">{{ event.venue_name }}<br><span class="text-stone-400">{{ event.venue_address }}</span></p>
                        {% if event.party_maps_url %}
                            <a href="{{ event.party_maps_url }}" target="_blank" class="inline-flex items-center mt-3 text-xs font-bold text-[#5D7355] hover:underline">
                                <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> {% translate "Adresa" %}
                            </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Timeline / Schedule -->
                {% if event.schedule_details %}
                <div class="bg-[#F3F0EB] rounded-xl p-8 text-left mb-8 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 text-white opacity-50 translate-x-8 -translate-y-8">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2L12,2c-5.52,0-10,4.48-10,10s4.48,10,10,10c5.52,0,10-4.48,10-10S17.52,2,12,2z M12,18c-3.31,0-6-2.69-6-6s2.69-6,6-6 s6,2.69,6,6S15.31,18,12,18z"/></svg>
                    </div>
                    <h3 class="font-serif text-2xl text-[#2C2C2C] mb-4 flex items-center">
                        <i data-lucide="clock" class="w-5 h-5 mr-2 text-[#5D7355]"></i>
                        {% translate "Cronologia evenimentelor" %}
                    </h3>
                    <div class="prose prose-stone prose-sm">
                        {{ event.schedule_details|linebreaks }}
                    </div>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- Floating RSVP Button (Mobile Friendly) -->
        {% if not is_preview %}
        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-40">
            <button @click="rsvpOpen = true" class="btn-botanical flex items-center gap-2 px-8 py-3 rounded-full shadow-lg font-serif text-lg tracking-wider">
                <span>{% translate "Confirmați acum" %}</span>
                <i data-lucide="send" class="w-4 h-4"></i>
            </button>
        </div>
        {% endif %}

    </div>

    <!-- ============================================== -->
    <!-- === RSVP MODAL (Centered Popup)            === -->
    <!-- ============================================== -->
    {% if not is_preview %}
    <div x-show="rsvpOpen"
         style="display: none;"
         class="fixed inset-0 z-50 flex items-center justify-center px-4">

        <!-- Backdrop -->
        <div class="absolute inset-0 bg-stone-900/60 backdrop-blur-sm"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="rsvpOpen = false"></div>

        <!-- Modal Content -->
        <div class="relative w-full max-w-md bg-white rounded-xl shadow-2xl p-8 max-h-[90vh] overflow-y-auto"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-8 scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 scale-100"
             x-transition:leave-end="opacity-0 translate-y-8 scale-95">

            <button @click="rsvpOpen = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <div class="text-center mb-6">
                <i data-lucide="mail" class="w-10 h-10 mx-auto text-[#5D7355] mb-2"></i>
                <h3 class="font-serif text-3xl text-[#2C2C2C]">{% translate "Vă rugăm confirmați" %}</h3>
                <p class="text-sm text-stone-500 mt-1">
                    {% translate "Pentru" %}
                    <span class="font-bold text-[#5D7355]">
                        {% if guest.honorific != 'none' %}{{ guest.get_honorific_display }} {% endif %}{{ guest.name }}
                    </span>
                </p>
            </div>

            <form id="rsvp-form" method="POST" action="{% url 'invapp:guest_invite' guest_uuid=guest.unique_id %}"
                  class="space-y-5"
                  data-manual-status="{% if guest.manual_is_attending is not None %}true{% else %}false{% endif %}">
                {% csrf_token %}

                <!-- Attendance Radios -->
                <div class="grid grid-cols-2 gap-4">
                    {% for radio in form.attending %}
                        <label class="cursor-pointer">
                            {{ radio.tag }}
                            <div class="border border-stone-200 rounded-lg p-3 text-center hover:border-[#5D7355] hover:bg-stone-50 transition-colors peer-checked:bg-[#5D7355] peer-checked:text-white peer-checked:border-[#5D7355]">
                                <span class="font-serif text-lg block">{{ radio.choice_label }}</span>
                            </div>
                        </label>
                    {% endfor %}
                </div>

                <!-- Details Section (Conditional in JS) -->
                <div id="attending_details" style="display: none;" class="space-y-4 bg-[#F9F8F6] p-4 rounded-lg">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-stone-500 mb-1">{% translate "Număr invitați" %}</label>
                        <input type="number" name="{{ form.number_attending.name }}" min="1" max="{{ guest.max_attendees }}" class="w-full border-stone-300 rounded-md focus:ring-[#5D7355] focus:border-[#5D7355]" placeholder="1">
                        <p class="text-[10px] text-stone-400 text-right mt-1">{% blocktranslate with max=guest.max_attendees %}Max allowed: {{ max }}{% endblocktranslate %}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-stone-500 mb-1">{% translate "Meniu Special" %}</label>
                        <textarea name="{{ form.meal_preference.name }}" rows="2" class="w-full border-stone-300 rounded-md focus:ring-[#5D7355] focus:border-[#5D7355]"></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-stone-500 mb-1">{% translate "Transmiteți un mesaj" %}</label>
                    <textarea name="{{ form.message.name }}" rows="2" class="w-full border-stone-300 rounded-md focus:ring-[#5D7355] focus:border-[#5D7355]"></textarea>
                </div>

                <button type="submit" class="btn-botanical w-full py-3 rounded-lg font-bold tracking-wider uppercase text-sm">
                    {% translate "Răspundeți" %}
                </button>
            </form>

        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Icons
    lucide.createIcons();

    // Countdown Logic
    function countdown(dateString) {
        return {
            time: { days: '00', hours: '00', minutes: '00', seconds: '00' },
            target: new Date(dateString).getTime(),
            init() {
                if (isNaN(this.target)) return;
                setInterval(() => {
                    const now = new Date().getTime();
                    const dist = this.target - now;
                    if (dist < 0) {
                        this.time = { days: '00', hours: '00', minutes: '00', seconds: '00' };
                        return;
                    }
                    this.time.days = Math.floor(dist / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
                    this.time.hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
                    this.time.minutes = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                    this.time.seconds = Math.floor((dist % (1000 * 60)) / 1000).toString().padStart(2, '0');
                }, 1000);
            }
        }
    }

    // RSVP DOM Logic
    document.addEventListener('DOMContentLoaded', function() {
        const radios = document.querySelectorAll('input[name="attending"]');
        const details = document.getElementById('attending_details');

        function toggle() {
            const yes = document.querySelector('input[name="attending"][value="True"]');
            if(yes && details) details.style.display = yes.checked ? 'block' : 'none';
        }

        radios.forEach(r => r.addEventListener('change', toggle));
        toggle(); // Init state

        // Confirmation Check
        const form = document.getElementById('rsvp-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const manual = this.getAttribute('data-manual-status') === 'true';
                if (manual && !confirm("{% translate 'This will update your previous response. Continue?' %}")) {
                    e.preventDefault();
                }
            });
        }
    });
</script>
{% endblock %}
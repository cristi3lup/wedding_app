{% extends "invapp/base_invite.html" %}
{% load static %}
{% load i18n %}

{% block page_specific_fonts %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;600&family=Cormorant+Garamond:ital,wght@0,300;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block page_specific_styles %}
<style>
    :root {
        --botanical-green: #5D7355;
        --soft-cream: #F9F7F2;
        --deep-forest: #2C3627;
        --accent-gold: #C5A368;
    }

    body {
        background-color: var(--soft-cream);
        color: var(--deep-forest);
        font-family: 'Montserrat', sans-serif;
        overflow-x: hidden;
    }

    .font-serif-display { font-family: 'Playfair Display', serif; }
    .font-classic { font-family: 'Cormorant Garamond', serif; }

    /* Animated leaves background */
    .leaf-bg {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: -1;
        opacity: 0.05;
        pointer-events: none;
        background-image: url('https://www.transparenttextures.com/patterns/leaf.png');
    }

    .section-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 4rem 1.5rem;
    }

    .botanical-card {
        background: white;
        border: 1px solid rgba(93, 115, 85, 0.1);
        box-shadow: 0 10px 30px rgba(0,0,0,0.03);
        border-radius: 0.5rem;
    }

    .btn-botanical {
        background-color: var(--botanical-green);
        color: white;
        transition: all 0.3s ease;
    }

    .btn-botanical:hover {
        background-color: var(--deep-forest);
        transform: translateY(-2px);
    }

    .nav-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #ddd;
        transition: all 0.3s ease;
    }

    .nav-dot.active {
        background-color: var(--botanical-green);
        transform: scale(1.5);
    }

    /* Scroll reveal */
    .reveal {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.8s ease-out;
    }

    .reveal.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .modal-overlay {
        background: rgba(44, 54, 39, 0.8);
        backdrop-filter: blur(4px);
    }

    .modal-input {
        border: 1px solid #ddd;
        border-radius: 0.375rem;
        padding: 0.75rem;
        width: 100%;
        transition: border-color 0.3s ease;
    }

    .modal-input:focus {
        border-color: var(--botanical-green);
        outline: none;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="{ rsvpOpen: false }" class="relative">
    <div class="leaf-bg"></div>

    <!-- 1. HERO SECTION -->
    <section class="min-h-screen flex flex-col items-center justify-center text-center px-6 relative overflow-hidden">
        <!-- Botanical Frame -->
        <div class="absolute top-0 left-0 w-32 md:w-48 opacity-20 transform -rotate-12">
            <img src="https://www.transparentpng.com/download/leaves/leaves-png-images-free-download-23.png" alt="leaf decoration">
        </div>
        <div class="absolute bottom-0 right-0 w-32 md:w-48 opacity-20 transform rotate-12">
            <img src="https://www.transparentpng.com/download/leaves/leaves-png-images-free-download-23.png" alt="leaf decoration">
        </div>

        <div class="reveal visible">
            <span class="text-xs uppercase tracking-[0.4em] text-stone-400 mb-6 block">{% translate "Save the Date" %}</span>
            <h1 class="font-serif-display text-5xl md:text-7xl mb-8 leading-tight">
                {{ event.bride_name|default:"Maria" }} <br>
                <span class="font-classic italic text-3xl md:text-4xl lowercase text-stone-400">&</span> <br>
                {{ event.groom_name|default:"Andrei" }}
            </h1>
            <div class="h-px w-20 bg-stone-300 mx-auto mb-8"></div>
            <p class="font-classic text-2xl md:text-3xl italic text-stone-600 mb-4">{{ event.event_date|date:"d F Y" }}</p>
            <p class="text-xs uppercase tracking-widest text-stone-400">{{ event.venue_name|default:_("Our Venue") }}</p>
        </div>

        <!-- Scroll down indicator -->
        <div class="absolute bottom-10 animate-bounce text-stone-300">
            <i class="fas fa-chevron-down text-xl"></i>
        </div>
    </section>

    <!-- 2. INVITATION STORY -->
    <section class="section-container text-center reveal">
        <div class="botanical-card p-8 md:p-16 relative">
            <!-- Top corner leaf -->
            <div class="absolute -top-6 -left-6 w-16 opacity-40">
                <img src="https://www.transparentpng.com/download/leaves/green-leaves-free-png-1.png" alt="leaf">
            </div>

            <!-- Intro Text (MIDDLE) -->
            <div class="mb-12">
                <p class="font-classic text-xl italic text-stone-500 mb-4">
                    {% translate "Together with our parents" %}
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="text-center">
                         <h2 class="font-serif text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-1 opacity-70">{% translate "Bride's Parents" %}</h2>
                         <p class="font-classic text-lg">{{ event.bride_parents }}</p>
                    </div>
                    <div class="text-center">
                         <h2 class="font-serif text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-1 opacity-70">{% translate "Groom's Parents" %}</h2>
                         <p class="font-classic text-lg">{{ event.groom_parents }}</p>
                    </div>
                </div>
            </div>

            {% if event.godparents.all %}
            <div class="mb-12">
                <p class="font-classic text-xl italic text-stone-500 mb-4">
                    {% translate "Together with our godparents" %}
                </p>
                <div class="flex flex-col gap-2">
                    {% for gp in event.godparents.all %}
                        <p class="font-serif text-xl text-stone-800">{{ gp.name }}</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="space-y-6">
                <p class="font-serif-display text-2xl text-stone-800 leading-relaxed">
                    {% translate "We invite you to celebrate our wedding" %}
                </p>
                <p class="font-classic text-lg text-stone-600 leading-relaxed">
                    {{ event.invitation_wording|default:_("We've chosen to walk life's path together and would be honored to have you by our side as we exchange our vows.") }}
                </p>
            </div>

            <div class="mt-12">
                <p class="text-xs text-stone-400 mt-2 uppercase tracking-wide">{% translate "Thank you" %}</p>
                <div class="mt-2 text-stone-800 font-serif-display text-xl">
                    {% if guest %}
                        {% if guest.honorific == 'family' %}
                            {% blocktranslate with name=guest.name %}Dear {{ name }} Family,{% endblocktranslate %}
                        {% elif guest.honorific == 'couple' %}
                            {% blocktranslate with name=guest.name %}Dear {{ name }} Couple,{% endblocktranslate %}
                        {% else %}
                             {% blocktranslate with name=guest.name %}Dear {{ name }},{% endblocktranslate %}
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <!-- 3. COUNTDOWN -->
    {% if event.event_date %}
    <section class="section-container text-center reveal"
             id="countdown-timer"
             data-event-date="{{ event.event_date|date:'Y-m-d' }}T{% if event.party_time %}{{ event.party_time|time:'H:i:s' }}{% elif event.ceremony_time %}{{ event.ceremony_time|time:'H:i:s' }}{% else %}00:00:00{% endif %}">
        <div class="flex justify-center gap-4 md:gap-8">
            <div class="w-20 md:w-24">
                <div id="days" class="text-4xl md:text-5xl font-serif-display text-stone-800 mb-1">00</div>
                <div class="text-[10px] uppercase tracking-widest text-stone-400">{% translate "Days" %}</div>
            </div>
            <div class="w-20 md:w-24">
                <div id="hours" class="text-4xl md:text-5xl font-serif-display text-stone-800 mb-1">00</div>
                <div class="text-[10px] uppercase tracking-widest text-stone-400">{% translate "Hours" %}</div>
            </div>
            <div class="w-20 md:w-24">
                <div id="minutes" class="text-4xl md:text-5xl font-serif-display text-stone-800 mb-1">00</div>
                <div class="text-[10px] uppercase tracking-widest text-stone-400">{% translate "Min" %}</div>
            </div>
            <div class="w-20 md:w-24">
                <div id="seconds" class="text-4xl md:text-5xl font-serif-display text-stone-800 mb-1">00</div>
                <div class="text-[10px] uppercase tracking-widest text-stone-400">{% translate "Sec" %}</div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- 4. LOCATION DETAILS -->
    <section class="section-container grid grid-cols-1 gap-12">
        <!-- Religious Ceremony -->
        <div class="botanical-card p-8 md:p-12 reveal text-center">
            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-stone-50 mb-6 text-[#5D7355]">
                <i class="fas fa-church text-xl"></i>
            </div>
            <h2 class="font-serif-display text-3xl mb-4">{% translate "Ceremony" %}</h2>
            <p class="font-classic text-2xl text-stone-600 mb-2">{{ event.ceremony_time|time:"H:i" }}</p>
            <p class="text-stone-800 font-bold mb-1">{{ event.ceremony_location|default:_("Ceremony Location Name") }}</p>
            <p class="text-stone-500 text-sm mb-6">{{ event.ceremony_address }}</p>
            {% if event.ceremony_maps_url %}
                <a href="{{ event.ceremony_maps_url }}" target="_blank" class="text-xs font-bold uppercase tracking-widest text-[#5D7355] border-b border-[#5D7355]/30 pb-1 hover:border-[#5D7355] transition-all">
                    {% translate "View Map" %}
                </a>
            {% endif %}
        </div>

        <!-- The Party -->
        <div class="botanical-card p-8 md:p-12 reveal text-center">
            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-stone-50 mb-6 text-[#5D7355]">
                <i class="fas fa-glass-cheers text-xl"></i>
            </div>
            <h2 class="font-serif-display text-3xl mb-4">{% translate "The Celebration" %}</h2>
            <p class="font-classic text-2xl text-stone-600 mb-2">{{ event.party_time|time:"H:i" }}</p>
            <p class="text-stone-800 font-bold mb-1">{{ event.venue_name }}</p>
            <p class="text-stone-500 text-sm mb-6">{{ event.venue_address }}</p>
            {% if event.party_maps_url %}
                <a href="{{ event.party_maps_url }}" target="_blank" class="text-xs font-bold uppercase tracking-widest text-[#5D7355] border-b border-[#5D7355]/30 pb-1 hover:border-[#5D7355] transition-all">
                    {% translate "View Map" %}
                </a>
            {% endif %}
        </div>
    </section>

    <!-- 5. TIMELINE/PROGRAM (If exists) -->
    {% if event.schedule_details %}
    <section class="section-container reveal">
        <h2 class="font-serif-display text-3xl text-center mb-12">{% translate "Program" %}</h2>
        <div class="space-y-8 border-l-2 border-stone-100 pl-8 ml-4">
            {{ event.schedule_details|linebreaks }}
        </div>
    </section>
    {% endif %}

    <!-- 6. RSVP FLOATING BUTTON -->
    {% if not is_preview %}
    <div class="fixed bottom-8 left-0 right-0 z-40 flex justify-center px-6">
        <button @click="rsvpOpen = true" class="btn-botanical py-4 px-10 rounded-full font-serif-display text-lg shadow-xl flex items-center gap-3 w-full max-w-xs justify-center">
            <i class="far fa-envelope-open"></i>
            <span>{% translate "Confirm Attendance" %}</span>
        </button>
    </div>
    {% endif %}

    <!-- 7. RSVP MODAL -->
    {% if not is_preview %}
    <div x-show="rsvpOpen" class="fixed inset-0 z-[100] flex items-center justify-center p-4 overflow-y-auto" x-cloak>
        <div @click="rsvpOpen = false" class="absolute inset-0 modal-overlay" x-show="rsvpOpen" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"></div>

        <div class="botanical-card w-full max-w-md bg-white p-8 relative z-10" x-show="rsvpOpen" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-8 scale-95" x-transition:enter-end="opacity-100 translate-y-0 scale-100">
            <button @click="rsvpOpen = false" class="absolute top-4 right-4 text-stone-400 hover:text-stone-800">
                <i class="fas fa-times text-xl"></i>
            </button>

            <h3 class="font-serif-display text-3xl text-center mb-2">{% translate "RSVP" %}</h3>
            <p class="text-stone-400 text-xs text-center uppercase tracking-widest mb-8">{% translate "For" %} {{ guest.name }}</p>

            <form id="rsvp-form" method="POST" action="{% url 'invapp:guest_invite' guest_uuid=guest.unique_id %}" class="space-y-6" data-manual-status="{% if guest.manual_is_attending is not None %}true{% else %}false{% endif %}">
                {% csrf_token %}

                <div class="flex justify-center gap-8 mb-8">
                    {% for radio in form.attending %}
                        <label class="flex flex-col items-center gap-2 cursor-pointer group">
                            {{ radio.tag }}
                            <span class="font-classic text-xl text-stone-500 group-hover:text-stone-800 transition-colors">{{ radio.choice_label }}</span>
                        </label>
                    {% endfor %}
                </div>

                <div id="attending_details" style="display: none;" class="space-y-6 animate-fade-in">
                    <div>
                        <label class="block text-[10px] font-bold uppercase tracking-[0.2em] text-stone-400 mb-2">
                            <i class="fas fa-user-friends mr-1"></i> {% translate "Number of Guests" %}
                        </label>
                        <input type="number" name="{{ form.number_attending.name }}" min="1" max="{{ guest.max_attendees }}" class="modal-input" placeholder="1">
                        <p class="text-[9px] text-stone-400 mt-1 uppercase tracking-widest text-right">Max: {{ guest.max_attendees }}</p>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase tracking-[0.2em] text-stone-400 mb-2">
                            <i class="fas fa-utensils mr-1"></i> {% translate "Special Menu / Allergies" %}
                        </label>
                        <textarea name="{{ form.meal_preference.name }}" rows="2" class="modal-input" placeholder="{% translate 'e.g. Vegetarian, Gluten-free...' %}"></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold uppercase tracking-[0.2em] text-stone-400 mb-2">
                        <i class="far fa-comment-dots mr-1"></i> {% translate "Message for the Couple" %}
                    </label>
                    <textarea name="{{ form.message.name }}" rows="2" class="modal-input" placeholder="{% translate 'Your wishes...' %}"></textarea>
                </div>

                <button type="submit" class="btn-botanical w-full py-4 rounded-md font-serif-display text-lg mt-4 shadow-lg shadow-stone-200">
                    {% translate "Send Response" %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Footer decoration -->
    <div class="section-container text-center text-stone-300 mt-20">
        <div class="h-px w-32 bg-stone-200 mx-auto mb-8"></div>
        <p class="font-classic italic text-lg mb-2 text-stone-400">InvApp Digital Invitations</p>
        <div class="flex justify-center gap-2 text-xs">
            <i class="fas fa-leaf opacity-20"></i>
            <i class="fas fa-heart opacity-20"></i>
            <i class="fas fa-leaf opacity-20"></i>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Reveal Observer
    const revealElements = document.querySelectorAll('.reveal');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.classList.add('visible');
        });
    }, { threshold: 0.1 });
    revealElements.forEach(el => observer.observe(el));

    // Countdown
    const countdownEl = document.getElementById('countdown-timer');
    if (countdownEl && countdownEl.dataset.eventDate) {
        const eventDate = new Date(countdownEl.dataset.eventDate).getTime();
        const timer = setInterval(() => {
            const now = new Date().getTime();
            const dist = eventDate - now;
            if (dist < 0) { clearInterval(timer); return; }
            document.getElementById('days').innerText = Math.floor(dist / 86400000).toString().padStart(2, '0');
            document.getElementById('hours').innerText = Math.floor((dist % 86400000) / 3600000).toString().padStart(2, '0');
            document.getElementById('minutes').innerText = Math.floor((dist % 3600000) / 60000).toString().padStart(2, '0');
            document.getElementById('seconds').innerText = Math.floor((dist % 60000) / 1000).toString().padStart(2, '0');
        }, 1000);
    }

    // RSVP Logic
    const rsvpForm = document.getElementById('rsvp-form');
    if (rsvpForm) {
        const attendingRadios = document.querySelectorAll('input[name="attending"]');
        const attendingDetailsDiv = document.getElementById('attending_details');
        const attendingYesRadio = document.querySelector('input[name="attending"][value="True"]');

        function toggleDetails() {
            if (attendingDetailsDiv && attendingYesRadio) {
                attendingDetailsDiv.style.display = attendingYesRadio.checked ? 'block' : 'none';
            }
        }
        attendingRadios.forEach(r => r.addEventListener('change', toggleDetails));
        toggleDetails();

        rsvpForm.addEventListener('submit', function(e) {
            const isManual = rsvpForm.getAttribute('data-manual-status') === 'true';
            if (isManual && !confirm("{% translate 'This will override your previous response. Continue?' %}")) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
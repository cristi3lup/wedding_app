{% extends "invapp/base.html" %}
{% load static %}

{% block page_specific_fonts %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
{% endblock %}

{% block page_specific_styles %}
<style>
    body {
        background-color: #f4f4f5; /* Light stone background */
        font-family: 'Poppins', sans-serif;
        color: #18181b; /* Zinc 900 for text */
    }
    .font-serif-display {
        font-family: 'Cormorant Garamond', serif;
    }
</style>
{% endblock %}


{% block content %}
<div class="max-w-md mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <div class="space-y-12">

        <!-- Hero Section -->
        <section class="text-center">
            {% if event.couple_photo %}
                <div class="w-full aspect-[3/4] rounded-lg overflow-hidden shadow-2xl mx-auto">
                    <img src="{{ event.couple_photo.url }}" alt="Couple Photo" class="w-full h-full object-cover">
                </div>
            {% endif %}
            <p class="mt-8 text-lg uppercase tracking-widest text-zinc-500">{{ event.title|default:"Ne căsătorim" }} </p>
            <h1 class="font-serif-display text-6xl sm:text-7xl font-bold text-zinc-900 mt-2">
                {{ event.bride_name|default:"Lucia" }} &<br>
                {{ event.groom_name|default:"Juan" }}
            </h1>
            <p class="font-serif-display text-3xl text-zinc-800 mt-4">{{ event.date_time|date:"d . m . Y" }}</p>
        </section>

        <!-- Countdown Timer -->
        <section id="countdown-timer" class="text-center" data-event-date="{{ event.date_time.isoformat }}">
            <p class="text-lg text-zinc-600 mb-2">Faltan:</p>
            <div class="grid grid-cols-4 gap-4 max-w-sm mx-auto p-6 bg-white rounded-lg shadow-lg">
                <div>
                    <p id="days" class="text-4xl font-serif-display text-zinc-900">00</p>
                    <p class="text-xs uppercase tracking-wider text-zinc-500">Zile</p>
                </div>
                <div>
                    <p id="hours" class="text-4xl font-serif-display text-zinc-900">00</p>
                    <p class="text-xs uppercase tracking-wider text-zinc-500">Ore</p>
                </div>
                <div>
                    <p id="minutes" class="text-4xl font-serif-display text-zinc-900">00</p>
                    <p class="text-xs uppercase tracking-wider text-zinc-500">Minute</p>
                </div>
                <div>
                    <p id="seconds" class="text-4xl font-serif-display text-zinc-900">00</p>
                    <p class="text-xs uppercase tracking-wider text-zinc-500">Secunde</p>
                </div>
            </div>
        </section>

        <!-- Event Details (Ceremony & Party) -->
        <section class="space-y-8">
            <div class="text-center p-8 bg-white rounded-lg shadow-lg">
                <div class="w-12 h-12 mx-auto text-zinc-500">
                    <!-- Church Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5M11.25 4.5l-7.5 7.5 7.5 7.5" /></svg>
                </div>
                <h2 class="font-serif-display text-3xl text-zinc-800 mt-4">Ceremonia</h2>
                <p class="mt-4 text-lg">{{ event.ceremony_time|default:"21:30 hs" }} - {{ event.ceremony_location|default:"Biserica X" }}</p>
                {% if event.ceremony_maps_url %}
                    <a href="{{ event.ceremony_maps_url }}" target="_blank" class="inline-block mt-4 px-6 py-2 text-sm font-semibold border border-zinc-800 text-zinc-800 rounded-full hover:bg-zinc-800 hover:text-white transition-colors">
                        Vezi locația
                    </a>
                {% endif %}
            </div>
            <div class="text-center p-8 bg-white rounded-lg shadow-lg">
                <div class="w-12 h-12 mx-auto text-zinc-500">
                    <!-- Champagne Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                </div>
                <h2 class="font-serif-display text-3xl text-zinc-800 mt-4">Petrecerea</h2>
                <p class="mt-4 text-lg">{{ event.venue_name|default:"Restaurant Y" }}</p>
                <p class="mt-1 text-base text-zinc-500">{{ event.venue_address }}</p>

                {% if event.party_maps_url %}
                    <!-- Embedded Map -->
                    <div class="mt-6 aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-md">
                        <iframe src="{{ event.party_maps_url }}" class="w-full h-full" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- RSVP Section -->
        {% if not is_preview %}
        <section id="rsvp" class="text-center p-8 bg-white rounded-lg shadow-lg">
            <h2 class="font-serif-display text-3xl text-zinc-800 mb-6">Confirmă prezența</h2>
            <form id="rsvp-form" method="POST" action="{% url 'invapp:guest_invite' guest_uuid=guest.unique_id %}" class="max-w-md mx-auto space-y-6">
                {% csrf_token %}
                 <div>
                    <fieldset>
                        <legend class="block text-lg font-medium text-zinc-700 mb-2">{{ form.attending.label }}</legend>
                        <div class="flex items-center justify-center space-x-6">
                            {% for radio in form.attending %}
                                <div class="flex items-center">
                                    {{ radio.tag }}
                                    <label for="{{ radio.id_for_label }}" class="ml-2 block text-lg text-zinc-700">{{ radio.choice_label }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    </fieldset>
                </div>

                <div id="attending_details" class="space-y-6 text-left" style="display: none;">
                    <div>
                        <label for="{{ form.number_attending.id_for_label }}" class="block text-lg font-medium text-zinc-700">{{ form.number_attending.label }}</for>
                        <div class="mt-1">
                            <input type="number" name="{{ form.number_attending.name }}" id="{{ form.number_attending.id_for_label }}" min="1" max="{{ guest.max_attendees }}" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-lg p-2" placeholder="e.g., 2">
                        </div>
                    </div>
                </div>

                <div class="pt-5">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-zinc-800 rounded-md shadow-sm text-lg font-semibold text-zinc-800 bg-transparent hover:bg-zinc-800 hover:text-white transition-colors">Trimite RSVP</button>
                </div>
            </form>
        </section>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Countdown Timer Logic
    const countdownEl = document.getElementById('countdown-timer');
    if (countdownEl) {
        const eventDate = new Date(countdownEl.dataset.eventDate).getTime();
        const timer = setInterval(function() {
            const now = new Date().getTime();
            const distance = eventDate - now;
            if (distance < 0) {
                clearInterval(timer);
                return;
            }
            document.getElementById('days').innerText = Math.floor(distance / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
            document.getElementById('hours').innerText = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
            document.getElementById('minutes').innerText = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            document.getElementById('seconds').innerText = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2, '0');
        }, 1000);
    }

    // RSVP Conditional Fields & Confirmation Logic
    const rsvpForm = document.getElementById('rsvp-form');
    if (rsvpForm) {
        const attendingRadios = document.querySelectorAll('input[name="attending"]');
        const attendingDetailsDiv = document.getElementById('attending_details');
        const attendingYesRadio = document.querySelector('input[name="attending"][value="True"]');
        const hasInitialResponse = "{{ guest.rsvp_details.attending|default:'None' }}" !== "None";

        function toggleAttendingDetails() {
            if (attendingYesRadio && attendingDetailsDiv) {
                attendingDetailsDiv.style.display = attendingYesRadio.checked ? 'block' : 'none';
            }
        }

        attendingRadios.forEach(radio => radio.addEventListener('change', toggleAttendingDetails));
        toggleAttendingDetails();

        rsvpForm.addEventListener('submit', function(event) {
            if (hasInitialResponse) {
                if (!confirm("Ați trimis deja un RSVP. Sigur doriți să modificați răspunsul?")) {
                    event.preventDefault();
                }
            }
        });
    }
});
</script>
{% endblock %}

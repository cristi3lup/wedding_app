{% extends "invapp/base_invite.html" %}
{% load static %}
{% load i18n %}

{% block page_specific_fonts %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,600;1,6..96,400&family=Great+Vibes&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
{% endblock %}

{% block page_specific_styles %}
<style>
    /* --- FONTS & COLORS --- */
    :root {
        --font-serif: 'Bodoni Moda', serif;
        --font-script: 'Great Vibes', cursive;
        --font-sans: 'Montserrat', sans-serif;
        --color-gold: #C5A059;
        --color-stone-900: #1c1917;
        --color-stone-100: #f5f5f4;
        --bg-paper: #f4f1ea;
    }

    body {
        background-color: #e7e5e4; /* darker grey background for contrast */
        font-family: var(--font-sans);
        color: var(--color-stone-900);
        overflow: hidden; /* Prevent scrolling while envelope is active */
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* --- MOBILE FRAME SIMULATION (Optional, keeps it looking like an 'App') --- */
    .app-container {
        position: relative;
        width: 100%;
        max-width: 450px;
        height: 100vh;
        max-height: 900px;
        background-color: var(--bg-paper);
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    @media (min-width: 768px) {
        .app-container {
            height: 85vh;
            border-radius: 40px;
            border: 8px solid #292524;
        }
    }

    /* --- ENVELOPE STYLES --- */
    .envelope-stage {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        background-color: rgba(0,0,0,0.1);
        backdrop-filter: blur(5px);
        transition: all 1s ease-in-out;
    }
    
    .envelope-stage.hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(1.1);
    }

    .envelope {
        position: relative;
        width: 300px;
        height: 200px;
        background-color: #8d8579;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: transform 0.5s ease;
    }

    .envelope:hover { transform: scale(1.02); }

    /* The Flap */
    .flap {
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 0;
        border-left: 150px solid transparent;
        border-right: 150px solid transparent;
        border-top: 110px solid #9e968b; /* Slightly lighter */
        transform-origin: top;
        transition: transform 0.6s ease-in-out 0.2s;
        z-index: 30;
    }
    .envelope.open .flap {
        transform: rotateX(180deg);
        z-index: 0; /* Moves behind the card when open */
    }

    /* The Pocket (Bottom/Sides) */
    .pocket-left {
        position: absolute;
        bottom: 0; left: 0;
        width: 0; height: 0;
        border-left: 150px solid #81796d;
        border-top: 100px solid transparent;
        border-bottom: 100px solid transparent;
        z-index: 20;
    }
    .pocket-right {
        position: absolute;
        bottom: 0; right: 0;
        width: 0; height: 0;
        border-right: 150px solid #81796d;
        border-top: 100px solid transparent;
        border-bottom: 100px solid transparent;
        z-index: 20;
    }
    .pocket-bottom {
        position: absolute;
        bottom: 0; left: 0;
        width: 0; height: 0;
        border-bottom: 110px solid #756d62;
        border-left: 150px solid transparent;
        border-right: 150px solid transparent;
        z-index: 21;
    }

    /* The Wax Seal */
    .wax-seal {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 60px; height: 60px;
        background: radial-gradient(circle, #d97706 0%, #92400e 100%);
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 40;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fcd34d;
        transition: opacity 0.3s ease;
    }
    .envelope.open .wax-seal { opacity: 0; pointer-events: none; }

    /* The Card Inside */
    .card-insert {
        position: absolute;
        top: 10px; left: 10px; right: 10px; bottom: 10px;
        background: white;
        z-index: 10;
        transition: transform 0.8s ease-out 0.8s; /* Delayed slide out */
        box-shadow: 0 -5px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .envelope.open .card-insert {
        transform: translateY(-180px); /* Slides up */
    }

    /* --- MAIN SCROLLING CONTENT --- */
    .main-content {
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        scroll-behavior: smooth;
        opacity: 0;
        transition: opacity 1s ease 1.5s; /* Fades in after envelope animation */
    }
    .main-content.visible { opacity: 1; }

    /* Hide scrollbar */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Timeline Styles */
    .timeline-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border: 1px solid #e7e5e4;
        border-radius: 8px;
        margin-bottom: 1rem;
        align-items: center;
    }
    .timeline-time {
        font-family: var(--font-serif);
        font-weight: bold;
        color: var(--color-gold);
        min-width: 70px;
        text-align: center;
    }
    
    /* Modal Styles */
    .modal-input {
        width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 12px; margin-top: 8px; font-family: 'Montserrat', sans-serif; font-size: 16px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Alpine x-data manages the state:
     envelopeOpen: triggers the CSS animation
     contentVisible: shows the main site after animation
     rsvpOpen: shows the modal
-->
<div x-data="{ envelopeOpen: false, contentVisible: false, rsvpOpen: false }" class="app-container">

    <!-- ============================================== -->
    <!-- === STATE 1: THE ENVELOPE                  === -->
    <!-- ============================================== -->
    <div class="envelope-stage" :class="{ 'hidden': contentVisible }">
        <div class="envelope" :class="{ 'open': envelopeOpen }" 
             @click="envelopeOpen = true; setTimeout(() => contentVisible = true, 1800)">
            
            <!-- The Card Inside -->
            <div class="card-insert">
                <div class="text-center">
                    <h1 class="font-serif text-2xl text-stone-800">{{ event.bride_name }} <br>&<br> {{ event.groom_name }}</h1>
                </div>
            </div>

            <!-- Envelope Parts -->
            <div class="flap"></div>
            <div class="pocket-left"></div>
            <div class="pocket-right"></div>
            <div class="pocket-bottom"></div>
            
            <!-- Wax Seal -->
            <div class="wax-seal">
                <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
            </div>

            <!-- Tap Hint -->
            <p x-show="!envelopeOpen" class="absolute -bottom-12 w-full text-center text-white/80 text-xs uppercase tracking-widest animate-pulse pointer-events-none">
                {% translate "Tap to Open" %}
            </p>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- === STATE 2: THE SCROLLING INVITATION      === -->
    <!-- ============================================== -->
    <div class="main-content no-scrollbar" :class="{ 'visible': contentVisible }">
        
        <!-- Slide 1: Intro & Names -->
        <section class="min-h-screen flex flex-col items-center justify-center text-center p-6 bg-white relative">
            <div class="absolute inset-0 bg-cover bg-center opacity-10 pointer-events-none" style="background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');"></div>
            
            <p class="font-serif text-lg text-stone-500 italic mb-6">{% translate "You are cordially invited to the wedding of" %}</p>
            
            <div class="mb-8 relative">
                 {% if event.get_couple_photo_url %}
                    <div class="w-64 h-80 rounded-t-[10rem] overflow-hidden border-4 border-white shadow-xl mx-auto mb-6">
                         <img src="{{ event.get_couple_photo_url }}" class="w-full h-full object-cover">
                    </div>
                {% endif %}
                <h1 class="font-serif text-5xl text-stone-900 leading-none mb-2">{{ event.bride_name }}</h1>
                <span class="font-script text-4xl text-[#C5A059]">&</span>
                <h1 class="font-serif text-5xl text-stone-900 leading-none mt-2">{{ event.groom_name }}</h1>
            </div>
            
            <div class="mt-4">
                <i data-lucide="chevron-down" class="w-6 h-6 text-[#C5A059] animate-bounce"></i>
            </div>
        </section>

        <!-- Slide 2: Date & Location -->
        <section class="py-16 px-6 bg-[#fbf9f6] text-center">
            <div class="inline-block border-y border-[#C5A059] py-2 px-8 mb-8">
                <p class="font-serif text-3xl text-stone-800">{{ event.event_date|date:"l, F d, Y" }}</p>
            </div>
            
            <div class="space-y-6">
                <!-- Ceremony -->
                <div>
                    <div class="flex justify-center mb-2 text-[#C5A059]"><i data-lucide="church" class="w-6 h-6"></i></div>
                    <h3 class="font-bold text-stone-800 uppercase tracking-wider text-sm">{% translate "Ceremony" %}</h3>
                    <p class="font-serif text-lg">{{ event.ceremony_time|time:"H:i" }}</p>
                    <p class="text-sm text-stone-500">{{ event.ceremony_location }}</p>
                </div>
                
                <!-- Reception -->
                <div>
                    <div class="flex justify-center mb-2 text-[#C5A059]"><i data-lucide="wine" class="w-6 h-6"></i></div>
                    <h3 class="font-bold text-stone-800 uppercase tracking-wider text-sm">{% translate "Reception" %}</h3>
                    <p class="font-serif text-lg">{{ event.party_time|time:"H:i" }}</p>
                    <p class="text-sm text-stone-500">{{ event.venue_name }}</p>
                    <p class="text-xs text-stone-400">{{ event.venue_address }}</p>
                </div>

                {% if event.Maps_embed_url %}
                <div class="mt-6 h-48 w-full rounded-lg overflow-hidden shadow-md">
                    <iframe src="{{ event.Maps_embed_url }}" class="w-full h-full border-0" allowfullscreen="" loading="lazy"></iframe>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Slide 3: Timeline (Program) -->
        <section class="py-16 px-6 bg-white">
            <h2 class="font-serif text-3xl text-center mb-8 text-[#C5A059]">{% translate "The Day" %}</h2>
            
            <div class="space-y-4">
                <!-- 
                   Since we don't have structured Timeline models yet, 
                   we will display the schedule_details text in a nice container. 
                -->
                <div class="p-6 bg-stone-50 rounded-lg border border-stone-100 text-center">
                    <div class="prose prose-stone font-serif text-stone-600">
                        {{ event.schedule_details|linebreaks }}
                    </div>
                </div>
            </div>
        </section>

        <!-- Slide 4: RSVP -->
        <section class="py-20 px-6 bg-[#1c1917] text-center text-white">
            <p class="font-serif italic text-stone-400 mb-4">{% translate "Kindly respond by" %} November 1st</p>
            <h2 class="font-script text-6xl text-[#C5A059] mb-8">RSVP</h2>
            
            {% if not is_preview %}
            <button @click="rsvpOpen = true" class="bg-[#C5A059] text-white px-10 py-4 rounded-full font-bold uppercase tracking-widest hover:bg-[#b08d4d] transition-transform transform hover:scale-105 shadow-lg">
                {% translate "Confirm Attendance" %}
            </button>
            {% endif %}
            
            <p class="mt-12 text-xs text-stone-600 uppercase tracking-widest">
                {{ event.bride_name }} & {{ event.groom_name }}
            </p>
        </section>

    </div>

    <!-- ============================================== -->
    <!-- === RSVP MODAL                             === -->
    <!-- ============================================== -->
    {% if not is_preview %}
    <div x-show="rsvpOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-90"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-90"
         class="fixed inset-0 z-[100] flex items-center justify-center px-4 bg-black/80 backdrop-blur-sm"
         style="display: none;">
         
        <div @click.away="rsvpOpen = false" class="bg-white w-full max-w-md rounded-xl shadow-2xl p-8 relative border-t-4 border-[#C5A059]">
            <button @click="rsvpOpen = false" class="absolute top-4 right-4 text-stone-400 hover:text-stone-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
    
            <h3 class="text-3xl font-serif text-center mb-2 text-[#C5A059]">{% translate "RSVP" %}</h3>
            <p class="text-center text-stone-500 text-xs uppercase tracking-wide mb-6">{% translate "Will you be joining us?" %}</p>
            
            <form method="POST" action="{% url 'invapp:guest_invite' guest_uuid=guest.unique_id %}" class="space-y-5">
                {% csrf_token %}
                
                <div class="flex justify-center gap-6 mb-4">
                    {% for radio in form.attending %}
                        <div class="flex items-center gap-2">
                            {{ radio.tag }}
                            <span class="text-sm font-bold text-stone-700">{{ radio.choice_label }}</span>
                        </div>
                    {% endfor %}
                </div>
    
                <div id="attending_details" style="display: none;" class="space-y-4">
                    <div>
                        <input type="number" name="{{ form.number_attending.name }}" min="1" max="{{ guest.max_attendees }}" class="modal-input" placeholder="{% translate 'Number of Guests' %}">
                        <p class="text-[10px] text-stone-400 text-right mt-1">{% blocktranslate with max=guest.max_attendees %}Max: {{ max }}{% endblocktranslate %}</p>
                    </div>
                    <div>
                        <textarea name="{{ form.meal_preference.name }}" rows="2" class="modal-input" placeholder="{% translate 'Dietary Requirements' %}"></textarea>
                    </div>
                </div>
                
                <div>
                    <textarea name="{{ form.message.name }}" rows="2" class="modal-input" placeholder="{% translate 'Message for the Couple' %}"></textarea>
                </div>
    
                <button type="submit" class="w-full bg-[#1c1917] text-white font-bold uppercase py-3 rounded hover:bg-[#C5A065] transition-colors">
                    {% translate "Send Response" %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}

</div>

<!-- Initialize Icons and Scripts -->
<script>
    lucide.createIcons();

    document.addEventListener('DOMContentLoaded', function() {
        // RSVP Toggle
        const radios = document.querySelectorAll('input[name="attending"]');
        const details = document.getElementById('attending_details');
        
        function toggleDetails() {
            const isYes = document.querySelector('input[name="attending"][value="True"]:checked');
            if(details) details.style.display = isYes ? 'block' : 'none';
        }

        radios.forEach(r => r.addEventListener('change', toggleDetails));
        toggleDetails();
    });
</script>
{% endblock %}
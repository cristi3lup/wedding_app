{% extends "invapp/base_invite.html" %}
{% load i18n static %}

{% block content %}
<div x-data="{ rsvpOpen: false, imageOpen: false }" class="relative min-h-[100dvh] bg-slate-950 flex flex-col items-center justify-center overflow-hidden font-sans text-white">
    
    <div class="absolute inset-0 z-0 overflow-hidden pointer-events-none">
        {% if event.main_invitation_image %}
            <img src="{{ event.main_invitation_image.url }}" class="w-full h-full object-cover opacity-40 blur-3xl scale-125 transform" alt="Ambient Background">
        {% elif event.couple_photo %}
            <img src="{{ event.couple_photo.url }}" class="w-full h-full object-cover opacity-40 blur-3xl scale-125 transform" alt="Ambient Background">
        {% endif %}
        <div class="absolute inset-0 bg-gradient-to-b from-slate-950/40 via-transparent to-slate-950/90"></div>
    </div>

    <div class="relative z-10 w-full max-w-lg px-6 py-12 flex flex-col items-center pb-32">
        {% if event.main_invitation_image %}
            <div class="relative group cursor-zoom-in" @click="imageOpen = true">
                <div class="absolute -inset-1 bg-gradient-to-r from-white/20 to-white/0 rounded-2xl blur opacity-25 group-hover:opacity-60 transition duration-500"></div>
                <img src="{{ event.main_invitation_image.url }}" class="relative w-full h-auto max-h-[75vh] object-contain rounded-xl shadow-2xl border border-white/10" alt="{{ event.title }}">
                <div class="absolute bottom-4 right-4 bg-black/60 backdrop-blur-md p-2 rounded-full text-white/80 sm:hidden">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                </div>
            </div>
        {% elif event.couple_photo %}
            <div class="relative group cursor-zoom-in" @click="imageOpen = true">
                <div class="absolute -inset-1 bg-gradient-to-r from-white/20 to-white/0 rounded-2xl blur opacity-25 group-hover:opacity-60 transition duration-500"></div>
                <img src="{{ event.couple_photo.url }}" class="relative w-full h-auto max-h-[75vh] object-contain rounded-xl shadow-2xl border border-white/10" alt="{{ event.title }}">
                <div class="absolute bottom-4 right-4 bg-black/60 backdrop-blur-md p-2 rounded-full text-white/80 sm:hidden">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                </div>
            </div>
        {% else %}
            <div class="text-white/50 text-sm font-bold tracking-widest uppercase border border-white/10 px-6 py-10 rounded-2xl backdrop-blur-sm">
                {% translate "Invitation image pending" %}
            </div>
        {% endif %}
    </div>

    <div class="fixed bottom-0 inset-x-0 p-6 z-20 flex justify-center pb-[env(safe-area-inset-bottom,1.5rem)] bg-gradient-to-t from-slate-950 via-slate-950/80 to-transparent">
        <button @click="rsvpOpen = true" 
                class="w-full max-w-sm bg-white text-slate-900 h-14 rounded-full font-black text-[12px] uppercase tracking-[0.2em] shadow-[0_0_30px_rgba(255,255,255,0.15)] active:scale-95 transition-all flex items-center justify-center gap-3">
            <span>{% translate "RSVP & Details" %}</span>
            <svg class="w-5 h-5 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
        </button>
    </div>

    <!-- RSVP MODAL -->
    <div x-show="rsvpOpen" x-cloak class="fixed inset-0 z-50 flex justify-center items-end sm:items-center bg-black/80 backdrop-blur-lg p-0 sm:p-4 lg:p-8"
         x-transition:enter="transition ease-out duration-500" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        
        <div class="bg-white dark:bg-slate-950 w-full max-w-4xl rounded-t-[2.5rem] sm:rounded-3xl h-[92vh] sm:h-auto sm:max-h-[85vh] flex flex-col md:flex-row shadow-2xl overflow-hidden transform transition-all border border-white/10"
             @click.away="rsvpOpen = false"
             x-transition:enter="transition ease-out duration-500 cubic-bezier(0.16, 1, 0.3, 1)" x-transition:enter-start="translate-y-full sm:translate-y-12 sm:scale-95" x-transition:enter-end="translate-y-0 sm:scale-100">
            
            <!-- LEFT SIDE: The Context & Map (DESKTOP ONLY) -->
            <div class="hidden md:flex md:w-[42%] bg-slate-100 dark:bg-slate-900 border-r border-gray-100 dark:border-slate-800 flex-col shrink-0">
                <div class="md:flex-1 relative" x-data="{ mapLoaded: false }">
                    <div x-show="!mapLoaded" class="absolute inset-0 flex items-center justify-center bg-slate-100 dark:bg-slate-900 z-10">
                        <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    {% if event.ceremony_location and event.venue_name %}
                        <iframe class="absolute inset-0 w-full h-full border-0" src="https://maps.google.com/maps?saddr={{ event.ceremony_location|urlencode }}&daddr={{ event.venue_name|urlencode }}&output=embed" allowfullscreen="" loading="lazy" @load="mapLoaded = true"></iframe>
                    {% else %}
                        <iframe class="absolute inset-0 w-full h-full border-0" src="https://maps.google.com/maps?q={{ event.ceremony_location|default:event.venue_name|urlencode }}&output=embed" allowfullscreen="" loading="lazy" @load="mapLoaded = true"></iframe>
                    {% endif %}
                </div>
                <div class="p-6 space-y-6 bg-slate-100 dark:bg-slate-900/50">
                    {% if event.ceremony_location %}
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center shrink-0 border border-gray-100 dark:border-slate-700">
                            <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                        <div>
                            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 dark:text-slate-500 mb-1">{% translate "Ceremony" %}</p>
                            <p class="text-sm font-bold text-gray-900 dark:text-white leading-tight">{{ event.ceremony_location }}</p>
                            {% if event.ceremony_time %}<p class="text-xs font-black text-indigo-500 mt-1.5 uppercase tracking-wider">{{ event.ceremony_time|time:"H:i" }}</p>{% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if event.venue_name %}
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center shrink-0 border border-gray-100 dark:border-slate-700">
                            <svg class="w-5 h-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-7.714 2.143L11 21l-2.286-6.857L1 12l7.714-2.143L11 3z"></path></svg>
                        </div>
                        <div>
                            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 dark:text-slate-500 mb-1">{% translate "Reception" %}</p>
                            <p class="text-sm font-bold text-gray-900 dark:text-white leading-tight">{{ event.venue_name }}</p>
                            {% if event.party_time %}<p class="text-xs font-black text-emerald-500 mt-1.5 uppercase tracking-wider">{{ event.party_time|time:"H:i" }}</p>{% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- RIGHT SIDE: The Experience (Personalized Form + Mobile Map) -->
            <div class="w-full md:w-[58%] flex-1 flex flex-col bg-white dark:bg-slate-950 overflow-hidden relative">
                <!-- Header (Fixed) -->
                <div class="shrink-0 p-8 sm:p-10 border-b border-gray-50 dark:border-slate-800/50 bg-white/80 dark:bg-slate-950/80 backdrop-blur-md sticky top-0 z-20 flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <h3 class="text-2xl sm:text-3xl font-serif text-gray-900 dark:text-white leading-tight">
                            {% if guest.name %}
                                {% blocktranslate with name=guest.get_full_display_name %}Dear {{ name }},{% endblocktranslate %}
                            {% endif %}
                            <span class="block text-lg sm:text-xl text-indigo-600 dark:text-indigo-400 mt-2 font-sans font-black uppercase tracking-tight">
                                {% translate "We are so happy to have you with us!" %}
                            </span>
                        </h3>
                    </div>
                    <button @click="rsvpOpen = false" class="shrink-0 w-10 h-10 bg-gray-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors active:scale-90">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Scrollable RSVP Content -->
                <div class="flex-1 overflow-y-auto p-8 sm:p-10 pt-6" style="scrollbar-width: none; -ms-overflow-style: none;">
                    <style>.hide-scrollbar::-webkit-scrollbar { display: none; }</style>
                    
                    <div class="text-gray-900 dark:text-white hide-scrollbar">
                        
                        <!-- MOBILE ONLY: Integrated Map & Details -->
                        <div class="md:hidden mb-10 space-y-6">
                            <div class="relative h-[200px] rounded-2xl overflow-hidden shadow-lg border border-gray-100 dark:border-slate-800" x-data="{ mobMapLoaded: false }">
                                <div x-show="!mobMapLoaded" class="absolute inset-0 flex items-center justify-center bg-gray-50 dark:bg-slate-900 z-10">
                                    <div class="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                                </div>

                                {% if event.ceremony_maps_url and 'embed' in event.ceremony_maps_url %}
                                    <iframe class="w-full h-full border-0 opacity-90" 
                                            src="{{ event.ceremony_maps_url }}" 
                                            allowfullscreen="" loading="lazy" @load="mobMapLoaded = true"></iframe>
                                {% elif event.party_maps_url and 'embed' in event.party_maps_url %}
                                    <iframe class="w-full h-full border-0 opacity-90" 
                                            src="{{ event.party_maps_url }}" 
                                            allowfullscreen="" loading="lazy" @load="mobMapLoaded = true"></iframe>
                                {% elif event.ceremony_address and event.venue_address %}
                                    <iframe class="w-full h-full border-0 opacity-90" 
                                            src="{% if GOOGLE_MAPS_API_KEY %}https://www.google.com/maps/embed/v1/directions?key={{ GOOGLE_MAPS_API_KEY }}&origin={{ event.ceremony_address|urlencode }}&destination={{ event.venue_address|urlencode }}&mode=driving{% else %}https://maps.google.com/maps?saddr={{ event.ceremony_address|urlencode }}&daddr={{ event.venue_address|urlencode }}&output=embed{% endif %}" 
                                            allowfullscreen="" loading="lazy" @load="mobMapLoaded = true"></iframe>
                                {% elif event.ceremony_address or event.venue_address %}
                                    <iframe class="w-full h-full border-0 opacity-90" 
                                            src="{% if GOOGLE_MAPS_API_KEY %}https://www.google.com/maps/embed/v1/place?key={{ GOOGLE_MAPS_API_KEY }}&q={% if event.ceremony_address %}{{ event.ceremony_address|urlencode }}{% else %}{{ event.venue_address|urlencode }}{% endif %}{% else %}https://maps.google.com/maps?q={% if event.ceremony_address %}{{ event.ceremony_address|urlencode }}{% else %}{{ event.venue_address|urlencode }}{% endif %}&output=embed{% endif %}" 
                                            allowfullscreen="" loading="lazy" @load="mobMapLoaded = true"></iframe>
                                {% else %}
                                    <div class="w-full h-full bg-slate-100 dark:bg-slate-900 flex flex-col items-center justify-center text-slate-400 relative overflow-hidden">
                                        <svg class="absolute inset-0 w-full h-full opacity-[0.03] dark:opacity-[0.05]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                        </svg>
                                        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">{% translate "Location pending" %}</p>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="grid grid-cols-1 gap-4">
                                {% if event.ceremony_location %}
                                <div class="flex items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl border border-slate-100 dark:border-slate-800/50">
                                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center shrink-0 shadow-sm border border-gray-100 dark:border-slate-700">
                                        <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    </div>
                                    <div class="min-w-0">
                                        <p class="text-[9px] font-black uppercase tracking-widest text-gray-400">{% translate "Ceremony" %}</p>
                                        <p class="text-sm font-bold truncate">{{ event.ceremony_location }}</p>
                                    </div>
                                </div>
                                {% endif %}
                                {% if event.venue_name %}
                                <div class="flex items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl border border-slate-100 dark:border-slate-800/50">
                                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center shrink-0 shadow-sm border border-gray-100 dark:border-slate-700">
                                        <svg class="w-5 h-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-7.714 2.143L11 21l-2.286-6.857L1 12l7.714-2.143L11 3z"></path></svg>
                                    </div>
                                    <div class="min-w-0">
                                        <p class="text-[9px] font-black uppercase tracking-widest text-gray-400">{% translate "Reception" %}</p>
                                        <p class="text-sm font-bold truncate">{{ event.venue_name }}</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="h-px bg-slate-100 dark:bg-slate-800 w-full"></div>
                        </div>

                        <!-- RSVP Form Partial -->
                        <div id="rsvp-form-container">
                            {% include "invapp/rsvp_form.html" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FULLSCREEN IMAGE LIGHTVIEW -->
    <div x-show="imageOpen" x-cloak 
         class="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4"
         x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">

        <button @click="imageOpen = false" class="absolute top-6 right-6 w-12 h-12 bg-white/10 rounded-full text-white flex items-center justify-center text-3xl z-[110] hover:bg-white/20 transition-colors">&times;</button>

        <div class="w-full h-full flex items-center justify-center overflow-auto" @click="imageOpen = false">
            <img src="{% if event.main_invitation_image %}{{ event.main_invitation_image.url }}{% else %}{{ event.couple_photo.url }}{% endif %}" 
                 class="max-w-full max-h-full object-contain pointer-events-auto" 
                 @click.stop>
        </div>
    </div>
</div>
{% endblock %}

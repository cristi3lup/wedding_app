{% extends "invapp/base_invite.html" %}
{% load static %}
{% load i18n %}

{% block page_specific_fonts %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Great+Vibes&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}

{% block page_specific_styles %}
<style>
    /* --- Theme Configuration --- */
    :root {
        --brand-bg: #fdfcf9;
        --brand-text: #5c5c5c;
        --brand-heading: #2a2a2a;
        --brand-accent: #d4afb9; /* Dusty Pink */
        --brand-accent-dark: #b9909b;
    }

    body {
        font-family: 'Montserrat', sans-serif;
        background-color: var(--brand-bg);
        color: var(--brand-text);
        /* Subtle grain texture */
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        overflow-x: hidden;
    }

    .font-serif { font-family: 'Cormorant Garamond', serif; }
    .font-script { font-family: 'Great Vibes', cursive; }

    /* --- Animations --- */
    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-8px) rotate(2deg); }
    }
    .animate-float { animation: float 6s ease-in-out infinite; }

    @keyframes float-delayed {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-8px) rotate(-2deg); }
    }
    .animate-float-delayed { animation: float-delayed 7s ease-in-out infinite 1s; }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up { animation: fadeInUp 1s ease-out forwards; }

    /* --- Components --- */
    .peony-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid white;
        box-shadow: 0 20px 40px -10px rgba(212, 175, 185, 0.2);
    }

    .btn-peony {
        background-color: var(--brand-accent);
        color: white;
        transition: all 0.3s ease;
        font-family: 'Cormorant Garamond', serif;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }
    .btn-peony:hover {
        background-color: var(--brand-accent-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(212, 175, 185, 0.4);
    }

    .modal-input {
        background-color: #f9f9f9;
        border: 1px solid #e5e7eb;
        transition: all 0.2s;
    }
    .modal-input:focus {
        background-color: white;
        border-color: var(--brand-accent);
        ring: 2px solid var(--brand-accent);
        outline: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- x-data for Modal & Language Menu -->
<div x-data="{ rsvpOpen: false }" class="relative min-h-screen pb-24">

    <!-- ============================================== -->
    <!-- === BACKGROUND GRAPHICS                    === -->
    <!-- ============================================== -->
    <!-- Top Left Peony -->
    <div class="fixed top-0 left-0 -z-10 w-64 md:w-96 opacity-90 pointer-events-none">
        <!-- Note: Using forward slashes for static path is standard -->
        <img src="{% static 'invapp/images/Peony.png' %}" alt="Peony" class="w-full h-auto -translate-x-1/3 -translate-y-1/4">
    </div>
    <!-- Bottom Right Peony -->
    <div class="fixed bottom-0 right-0 -z-10 w-72 md:w-[30rem] opacity-80 pointer-events-none">
        <img src="{% static 'invapp/images/Peony.png' %}" alt="Peony" class="w-full h-auto translate-x-1/4 translate-y-1/4 rotate-180 transform scale-x-[-1]">
    </div>

    <!-- ============================================== -->
    <!-- === MAIN CONTENT                           === -->
    <!-- ============================================== -->
    <div class="max-w-2xl mx-auto py-12 px-4 sm:px-6 relative z-10">

        <!-- Card Container -->
        <div class="peony-card rounded-t-[2rem] rounded-b-lg overflow-hidden fade-in-up">

            <!-- Hero / Cover -->
            <div class="relative">
                {% if event.get_couple_photo_url %}
                    <div class="h-96 md:h-[30rem] overflow-hidden relative">
                         <img src="{{ event.get_couple_photo_url }}" alt="Couple" class="w-full h-full object-cover">
                         <div class="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent opacity-90"></div>
                    </div>
                {% else %}
                    <div class="h-32 bg-gradient-to-b from-[#fdfcf9] to-white"></div>
                {% endif %}

                <!-- Titles Overlay -->
                <div class="absolute bottom-0 left-0 right-0 text-center pb-10 px-4">
                    <p class="uppercase tracking-[0.25em] text-xs md:text-sm text-stone-600 font-semibold mb-4" style="text-shadow: 0 1px 2px rgba(255,255,255,0.9);">{% translate "We are getting married" %}</p>
                    <h1 class="font-script text-6xl md:text-8xl text-[#2a2a2a] leading-tight" style="text-shadow: 2px 2px 4px rgba(255,255,255,0.8);">
                        {{ event.bride_name|default:"Jane" }}
                        <span class="block text-5xl md:text-6xl text-[#b9909b] my-3 font-normal" style="text-shadow: 2px 2px 4px rgba(255,255,255,0.9);">&</span>
                        {{ event.groom_name|default:"John" }}
                    </h1>
                </div>
            </div>

            <!-- Body Content -->
            <div class="px-8 md:px-12 pb-12 text-center">

                <!-- Date & Countdown -->
                <div class="mb-12 border-y border-[#d4afb9]/30 py-8">
                    <p class="font-serif text-3xl md:text-4xl text-[#2a2a2a] mb-2">
                        {{ event.event_date|date:"l, d F Y" }}
                    </p>

                    {% if event.event_date %}
                    <!-- Updated x-data to avoid syntax errors and x-init redundant call -->
                    <div x-data="countdown('{{ event.event_date|date:'Y-m-d' }}T{% if event.party_time %}{{ event.party_time|time:'H:i:s' }}{% else %}00:00:00{% endif %}')"
                         class="flex justify-center gap-6 mt-6 font-serif text-[#b9909b]">
                        <div class="text-center"><span x-text="time.days" class="block text-2xl font-bold leading-none"></span><span class="text-[10px] uppercase tracking-widest">{% translate "Days" %}</span></div>
                        <div class="text-center"><span x-text="time.hours" class="block text-2xl font-bold leading-none"></span><span class="text-[10px] uppercase tracking-widest">{% translate "Hrs" %}</span></div>
                        <div class="text-center"><span x-text="time.minutes" class="block text-2xl font-bold leading-none"></span><span class="text-[10px] uppercase tracking-widest">{% translate "Min" %}</span></div>
                        <div class="text-center"><span x-text="time.seconds" class="block text-2xl font-bold leading-none"></span><span class="text-[10px] uppercase tracking-widest">{% translate "Sec" %}</span></div>
                    </div>
                    {% endif %}
                </div>

                <!-- Invitation Text -->
                <div class="prose prose-stone mx-auto mb-12 font-serif text-xl leading-relaxed text-gray-600">
                    {{ event.invitation_wording|linebreaks }}
                </div>

                <!-- Parents & Godparents -->
                <div class="grid md:grid-cols-2 gap-8 mb-12 text-sm">
                    <div>
                        <h3 class="uppercase tracking-widest text-xs font-bold text-[#b9909b] mb-2">{% translate "Parents" %}</h3>
                        <p class="font-serif text-lg">{{ event.bride_parents }}</p>
                        <p class="font-serif text-lg">{{ event.groom_parents }}</p>
                    </div>
                    {% if event.godparents.all %}
                    <div>
                        <h3 class="uppercase tracking-widest text-xs font-bold text-[#b9909b] mb-2">{% translate "Godparents" %}</h3>
                        {% for gp in event.godparents.all %}
                            <p class="font-serif text-lg">{{ gp.name }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Details Cards -->
                <div class="grid gap-6 md:grid-cols-2 text-left mb-12">
                    <!-- Ceremony -->
                    <div class="bg-[#f9f9f9] p-6 rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3 mb-3 text-[#b9909b]">
                            <i data-lucide="church" class="w-5 h-5"></i>
                            <h3 class="font-serif text-xl font-bold text-[#2a2a2a]">{% translate "Ceremony" %}</h3>
                        </div>
                        <p class="text-lg font-medium">{{ event.ceremony_time|time:"H:i" }}</p>
                        <p class="text-sm text-gray-600 mt-1">{{ event.ceremony_location }}</p>
                        {% if event.ceremony_maps_url %}
                            <a href="{{ event.ceremony_maps_url }}" target="_blank" class="inline-block mt-3 text-xs font-bold uppercase tracking-wider text-[#b9909b] hover:text-[#2a2a2a] underline">{% translate "Maps" %}</a>
                        {% endif %}
                    </div>

                    <!-- Party -->
                    <div class="bg-[#f9f9f9] p-6 rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3 mb-3 text-[#b9909b]">
                            <i data-lucide="wine" class="w-5 h-5"></i>
                            <h3 class="font-serif text-xl font-bold text-[#2a2a2a]">{% translate "Party" %}</h3>
                        </div>
                        <p class="text-lg font-medium">{{ event.party_time|time:"H:i" }}</p>
                        <p class="text-sm text-gray-600 mt-1">{{ event.venue_name }}</p>
                        <p class="text-xs text-gray-400">{{ event.venue_address }}</p>
                        {% if event.party_maps_url %}
                            <a href="{{ event.party_maps_url }}" target="_blank" class="inline-block mt-3 text-xs font-bold uppercase tracking-wider text-[#b9909b] hover:text-[#2a2a2a] underline">{% translate "Maps" %}</a>
                        {% endif %}
                    </div>
                </div>

                <!-- Timeline -->
                {% if event.schedule_details %}
                <div class="mb-12">
                    <h3 class="font-serif text-2xl font-bold text-[#2a2a2a] mb-4">{% translate "Timeline" %}</h3>
                    <div class="border-l-2 border-[#d4afb9] pl-6 ml-4 text-left space-y-4 font-serif text-lg text-gray-600">
                        {{ event.schedule_details|linebreaks }}
                    </div>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- Floating RSVP Button -->
        {% if not is_preview %}
        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 shadow-xl rounded-full">
            <button @click="rsvpOpen = true" class="btn-peony flex items-center gap-3 px-8 py-4 rounded-full text-lg">
                <i data-lucide="mail" class="w-5 h-5"></i>
                <span>{% translate "RSVP Now" %}</span>
            </button>
        </div>
        {% endif %}
    </div>

    <!-- ============================================== -->
    <!-- === RSVP MODAL                             === -->
    <!-- ============================================== -->
    {% if not is_preview %}
    <div x-show="rsvpOpen"
         style="display: none;"
         class="fixed inset-0 z-50 flex items-center justify-center px-4">

        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"
             x-transition.opacity
             @click="rsvpOpen = false"></div>

        <!-- Modal -->
        <div class="relative w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 max-h-[90vh] overflow-y-auto"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-10 scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 scale-100">

            <button @click="rsvpOpen = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <div class="text-center mb-8">
                <h3 class="font-serif text-3xl text-[#2a2a2a] mb-1">{% translate "Kindly Respond" %}</h3>
                <p class="text-sm text-gray-500">
                    {% translate "For" %}
                    <span class="font-bold text-[#b9909b]">
                        {% if guest.honorific != 'none' %}{{ guest.get_honorific_display }} {% endif %}{{ guest.name }}
                    </span>
                </p>
            </div>

            <form id="rsvp-form" method="POST" action="{% url 'invapp:guest_invite' guest_uuid=guest.unique_id %}"
                  class="space-y-6"
                  data-manual-status="{% if guest.manual_is_attending is not None %}true{% else %}false{% endif %}">
                {% csrf_token %}

                <!-- Attendance -->
                <div class="grid grid-cols-2 gap-4">
                    {% for radio in form.attending %}
                        <label class="cursor-pointer relative">
                            {{ radio.tag }}
                            <div class="border border-gray-200 rounded-xl p-4 text-center hover:border-[#d4afb9] hover:bg-[#fdfcf9] transition-colors peer-checked:bg-[#d4afb9] peer-checked:text-white peer-checked:border-[#d4afb9]">
                                <span class="font-serif text-xl block">{{ radio.choice_label }}</span>
                            </div>
                        </label>
                    {% endfor %}
                </div>

                <!-- Details -->
                <div id="attending_details" style="display: none;" class="space-y-4 bg-[#fdfcf9] p-5 rounded-xl border border-gray-100">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">{% translate "Guests" %}</label>
                        <input type="number" name="{{ form.number_attending.name }}" min="1" max="{{ guest.max_attendees }}" class="w-full p-3 rounded-lg modal-input" placeholder="1">
                        <p class="text-[10px] text-gray-400 text-right mt-1">Max: {{ guest.max_attendees }}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">{% translate "Dietary Restrictions" %}</label>
                        <textarea name="{{ form.meal_preference.name }}" rows="2" class="w-full p-3 rounded-lg modal-input"></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">{% translate "Message" %}</label>
                    <textarea name="{{ form.message.name }}" rows="3" class="w-full p-3 rounded-lg modal-input" placeholder="{% translate 'Leave a note for the couple...' %}"></textarea>
                </div>

                <button type="submit" class="btn-peony w-full py-4 rounded-xl shadow-lg">
                    {% translate "Send Response" %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Icons
    lucide.createIcons();

    // Countdown Logic updated for Alpine v3 reactivity
    function countdown(dateString) {
        return {
            time: { days: '00', hours: '00', minutes: '00', seconds: '00' },
            target: new Date(dateString).getTime(),
            init() {
                if (isNaN(this.target)) return;

                const update = () => {
                    const now = new Date().getTime();
                    const dist = this.target - now;
                    if (dist < 0) {
                        this.time = { days: '00', hours: '00', minutes: '00', seconds: '00' };
                        clearInterval(this.interval);
                        return;
                    }
                    this.time.days = String(Math.floor(dist / (1000 * 60 * 60 * 24))).padStart(2, '0');
                    this.time.hours = String(Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).padStart(2, '0');
                    this.time.minutes = String(Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                    this.time.seconds = String(Math.floor((dist % (1000 * 60)) / 1000)).padStart(2, '0');
                };

                update(); // Run immediately
                this.interval = setInterval(update, 1000);
            }
        }
    }

    // RSVP Logic
    document.addEventListener('DOMContentLoaded', function() {
        const radios = document.querySelectorAll('input[name="attending"]');
        const details = document.getElementById('attending_details');

        function toggle() {
            const yes = document.querySelector('input[name="attending"][value="True"]');
            if(yes && details) details.style.display = yes.checked ? 'block' : 'none';
        }

        radios.forEach(r => r.addEventListener('change', toggle));
        toggle();

        const form = document.getElementById('rsvp-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const manual = this.getAttribute('data-manual-status') === 'true';
                if (manual && !confirm("{% translate 'This will override the manual update. Continue?' %}")) {
                    e.preventDefault();
                }
            });
        }
    });
</script>
{% endblock %}
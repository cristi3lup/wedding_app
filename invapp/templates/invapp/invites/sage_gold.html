{% extends "invapp/base_invite.html" %}
{% load static %}
{% load i18n %}

{% block page_specific_fonts %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Montserrat:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block page_specific_styles %}
<style>
    /* Custom Font Assignments */
    .font-monogram { font-family: 'Cinzel', serif; }
    .font-serif { font-family: 'Playfair Display', serif; }
    .font-sans { font-family: 'Montserrat', sans-serif; }

    /* Sage Green Theme Colors */
    .bg-sage { background-color: #8da399; }
    .text-sage-dark { color: #2f3e46; }
    .text-eucalyptus { color: #5f7161; }
    .text-gold { color: #d4af37; }

    /* Paper Texture */
    .bg-card-texture {
        background-color: #ffffff;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    }

    /* Wax Seal Style */
    .wax-seal {
        background: linear-gradient(135deg, #b8860b 0%, #d4af37 50%, #aa771c 100%);
        box-shadow: 0 4px 6px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.4);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
    }
    .wax-seal:hover { transform: scale(1.1); }

    /* Animations */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0px); }
    }
    .animate-float { animation: float 5s ease-in-out infinite; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 1.5s ease-out forwards; }

    /* Modal Styles */
    .modal-input {
        width: 100%; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px; margin-top: 5px; font-family: 'Montserrat', sans-serif;
    }

    .btn-gold {
        background-color: #d4af37;
        color: white;
        padding: 12px;
        border-radius: 4px;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: background-color 0.3s;
        width: 100%;
        margin-top: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn-gold:hover { background-color: #b8860b; }

</style>
{% endblock %}

{% block content %}
<!-- x-data handles RSVP modal and Language dropdown -->
<div x-data="{ rsvpOpen: false, langOpen: false }" class="bg-sage min-h-screen flex items-center justify-center p-4 lg:p-8 font-sans">

    <!-- Main Card -->
    <div class="relative w-full max-w-lg bg-card-texture shadow-2xl rounded-sm overflow-hidden fade-in flex flex-col min-h-[90vh]">

        <!-- Language Switcher (Top Right) -->
        <div class="absolute top-4 right-4 z-50" @mouseenter="langOpen = true" @mouseleave="langOpen = false">
            <div class="relative">
                <button @click="langOpen = !langOpen" class="flex items-center justify-center space-x-1 bg-white/60 backdrop-blur-md border border-stone-200 shadow-sm rounded-full px-2 py-1 text-[10px] font-bold text-stone-600 uppercase tracking-wider hover:bg-white transition-all">
                    <i class="fas fa-globe mr-1 text-eucalyptus"></i>
                    <span>{{ LANGUAGE_CODE }}</span>
                </button>

                <!-- Dropdown -->
                <div x-show="langOpen"
                     x-transition:enter="transition ease-out duration-200"
                     class="absolute right-0 mt-2 w-24 bg-white rounded-lg shadow-lg overflow-hidden border border-stone-100 py-1"
                     style="display: none;">
                    <form action="{% url 'set_language' %}" method="post">
                        {% csrf_token %}
                        <input name="next" type="hidden" value="{{ redirect_to }}">
                        <button type="submit" name="language" value="ro" class="w-full text-left px-4 py-2 text-[10px] text-stone-700 hover:bg-stone-50 {% if LANGUAGE_CODE == 'ro' %}font-bold text-eucalyptus{% endif %}">Română</button>
                        <button type="submit" name="language" value="en" class="w-full text-left px-4 py-2 text-[10px] text-stone-700 hover:bg-stone-50 {% if LANGUAGE_CODE == 'en' %}font-bold text-eucalyptus{% endif %}">English</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Watercolor Eucalyptus Decoration (Top) -->
        <div class="absolute top-0 left-0 w-full h-48 pointer-events-none z-0">
            <svg viewBox="0 0 400 150" preserveAspectRatio="none" class="w-full h-full">
                <defs>
                    <filter id="watercolor">
                        <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="5" result="noise"/>
                        <feDisplacementMap in="SourceGraphic" in2="noise" scale="5" />
                    </filter>
                </defs>
                <g filter="url(#watercolor)" opacity="0.8">
                    <!-- Left Branch -->
                    <path d="M-20,20 Q30,50 80,30 T150,60" stroke="#7c9a85" stroke-width="2" fill="none"/>
                    <ellipse cx="20" cy="20" rx="15" ry="25" fill="#8da399" opacity="0.6" transform="rotate(-30 20 20)"/>
                    <ellipse cx="60" cy="40" rx="18" ry="28" fill="#6b8c7a" opacity="0.5" transform="rotate(10 60 40)"/>
                    <ellipse cx="100" cy="30" rx="12" ry="20" fill="#9dbfb0" opacity="0.7" transform="rotate(-45 100 30)"/>
                    <ellipse cx="130" cy="60" rx="15" ry="22" fill="#5f7161" opacity="0.4" transform="rotate(20 130 60)"/>

                    <!-- Right Branch -->
                    <path d="M420,10 Q350,60 300,30 T220,50" stroke="#7c9a85" stroke-width="2" fill="none"/>
                    <ellipse cx="380" cy="30" rx="20" ry="30" fill="#8da399" opacity="0.5" transform="rotate(45 380 30)"/>
                    <ellipse cx="330" cy="50" rx="15" ry="25" fill="#6b8c7a" opacity="0.6" transform="rotate(-10 330 50)"/>
                    <ellipse cx="280" cy="30" rx="18" ry="28" fill="#9dbfb0" opacity="0.4" transform="rotate(30 280 30)"/>
                </g>
            </svg>
        </div>

        <!-- Content Area -->
        <div class="relative z-10 px-8 py-12 flex flex-col items-center text-center h-full justify-between flex-grow">

            <!-- Monogram Section -->
            <div class="mt-8 mb-8 animate-float">
                <h1 class="font-monogram text-7xl md:text-8xl text-stone-800 tracking-tighter leading-none relative">
                    {{ event.bride_name|slice:":1" }}<span class="text-4xl align-middle mx-2 text-stone-400 font-light">|</span>{{ event.groom_name|slice:":1" }}
                </h1>
            </div>

            <!-- Intro -->
            <p class="font-sans text-[10px] md:text-xs font-medium tracking-widest text-stone-500 uppercase mb-6">
                {% translate "We invite you to be with us" %}
            </p>

            <!-- Names -->
            <div class="mb-8 w-full">
                <h2 class="font-sans text-lg md:text-xl font-semibold tracking-[0.15em] text-stone-800 uppercase mb-4 leading-relaxed">
                    {{ event.bride_name }} <span class="text-sm align-middle px-2 text-stone-400 lowercase italic">{% translate "and" %}</span> {{ event.groom_name }}
                </h2>
                <div class="w-16 h-px bg-stone-300 mx-auto my-4"></div>
            </div>

            <!-- Date -->
            <div class="mb-10 relative">
                <div class="absolute inset-0 flex items-center justify-center opacity-5">
                   <i data-lucide="heart" class="w-24 h-24 text-eucalyptus fill-current"></i>
                </div>
                <p class="font-serif text-3xl md:text-4xl text-stone-800 font-bold tracking-wide italic">
                    {{ event.date_time|date:"d . m . Y" }}
                </p>
            </div>

            <!-- Parents & Godparents -->
            <div class="space-y-8 mb-10 w-full max-w-sm">
                {% if event.bride_parents or event.groom_parents %}
                <div>
                    <h3 class="font-sans text-[10px] font-bold text-eucalyptus uppercase tracking-widest mb-2">
                        {% translate "With the blessing of parents" %}
                    </h3>
                    <div class="font-serif text-sm text-stone-700 leading-relaxed">
                        {% if event.bride_parents %}<p>{{ event.bride_parents }}</p>{% endif %}
                        {% if event.groom_parents %}<p>{{ event.groom_parents }}</p>{% endif %}
                    </div>
                </div>
                {% endif %}

                {% if event.godparents.exists %}
                <div>
                    <h3 class="font-sans text-[10px] font-bold text-eucalyptus uppercase tracking-widest mb-2">
                        {% translate "Together with godparents" %}
                    </h3>
                    <div class="font-serif text-sm text-stone-700">
                        {% for gp in event.godparents.all %}
                            <p>{{ gp.name }}</p>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Specific Guest Greeting -->
            <div class="mb-8 font-serif text-stone-500 text-sm italic">
                 {% if guest.honorific == 'family' %}
                    {% blocktranslate with name=guest.name %}Dear The {{ name }} Family{% endblocktranslate %}
                {% elif guest.honorific == 'couple' %}
                    {% blocktranslate with name=guest.name %}Dear The {{ name }} Couple{% endblocktranslate %}
                {% else %}
                     {% blocktranslate with name=guest.name %}Dear {{ name }}{% endblocktranslate %}
                {% endif %}
            </div>

            <!-- Locations (Timeline) -->
            <div class="w-full space-y-8 mb-12 border-t border-b border-stone-100 py-8 relative">
                <!-- Ceremony -->
                <div class="flex flex-col items-center">
                    <div class="text-eucalyptus mb-2">
                        <i data-lucide="church" class="w-5 h-5"></i>
                    </div>
                    <div class="font-sans text-xs font-bold text-stone-900 mb-1 uppercase tracking-wider">
                        {% translate "Religious Ceremony" %} - {{ event.ceremony_time|time:"H:i" }}
                    </div>
                    <p class="font-serif text-sm text-stone-600 italic">{{ event.ceremony_location|default:'Church' }}</p>
                    {% if event.ceremony_maps_url %}
                        <a href="{{ event.ceremony_maps_url }}" target="_blank" class="text-[10px] text-stone-400 hover:text-eucalyptus underline mt-1 uppercase tracking-wide">{% translate "View Map" %}</a>
                    {% endif %}
                </div>

                <!-- Party -->
                <div class="flex flex-col items-center">
                    <div class="text-eucalyptus mb-2">
                        <i data-lucide="wine" class="w-5 h-5"></i>
                    </div>
                    <div class="font-sans text-xs font-bold text-stone-900 mb-1 uppercase tracking-wider">
                        {% translate "The Party" %} - {{ event.date_time|time:"H:i" }}
                    </div>
                    <p class="font-serif text-sm text-stone-600 italic">{{ event.venue_name }}</p>
                    <p class="font-sans text-[10px] text-stone-400 mt-1">{{ event.venue_address }}</p>
                    {% if event.party_maps_url %}
                        <a href="{{ event.party_maps_url }}" target="_blank" class="text-[10px] text-stone-400 hover:text-eucalyptus underline mt-1 uppercase tracking-wide">{% translate "View Map" %}</a>
                    {% endif %}
                </div>
            </div>

            <!-- Footer / RSVP -->
            <div class="mt-auto w-full text-center pb-8">
                <p class="font-sans text-[10px] uppercase tracking-wider text-stone-500 mb-6">
                    {% translate "Please confirm your attendance" %}
                </p>

                <!-- Interactive RSVP Button (Wax Seal Style) -->
                {% if not is_preview %}
                <button @click="rsvpOpen = true" class="group relative inline-flex items-center justify-center p-4 mx-auto transform hover:scale-105 transition-transform duration-300">
                    <div class="absolute inset-0 rounded-full wax-seal w-16 h-16 mx-auto flex items-center justify-center"></div>
                    <span class="relative z-10 text-white font-serif text-xs font-bold tracking-widest uppercase drop-shadow-md pt-1 pl-0.5">
                        RSVP
                    </span>
                </button>
                {% endif %}

                <p class="font-serif text-lg italic text-stone-800 mt-8">
                    {% translate "We can't wait to see you!" %}
                </p>
            </div>

        </div>
    </div>

    <!-- ============================================== -->
    <!-- === RSVP MODAL (Standard Alpine Modal)     === -->
    <!-- ============================================== -->
    {% if not is_preview %}
    <div x-show="rsvpOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center px-4 bg-stone-900/60 backdrop-blur-sm"
         style="display: none;">

        <div @click.away="rsvpOpen = false" class="bg-white w-full max-w-md rounded-sm shadow-2xl p-8 relative overflow-y-auto max-h-[90vh] border-t-4 border-[#8da399]">
            <button @click="rsvpOpen = false" class="absolute top-4 right-4 text-stone-400 hover:text-stone-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <!-- Title is Gold to match theme -->
            <h3 class="text-3xl font-serif text-center mb-2 text-gold">{% translate "RSVP" %}</h3>
            <p class="text-center text-stone-500 text-xs uppercase tracking-wide mb-6">{% translate "Please confirm your attendance" %}</p>

            <!-- FORM with manual update logic -->
            <form id="rsvp-form" method="POST"
                  action="{% url 'invapp:guest_invite' guest_uuid=guest.unique_id %}"
                  class="space-y-5 mt-6"
                  data-manual-status="{% if guest.manual_is_attending is not None %}true{% else %}false{% endif %}">
                {% csrf_token %}

                <div class="text-center mb-6">
                    <label class="block text-xs font-bold uppercase tracking-widest mb-3 text-stone-600">{% translate "Will you attend?" %}</label>
                    <div class="flex justify-center gap-6">
                        {% for radio in form.attending %}
                            <div class="flex items-center gap-2">
                                {{ radio.tag }}
                                <span class="text-sm font-serif italic">{{ radio.choice_label }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="attending_details" style="display: none;" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-widest mb-1 text-stone-500">{% translate "Number of Guests" %}</label>
                        <!-- Added max validation and oninvalid logic -->
                        <input type="number"
                               name="{{ form.number_attending.name }}"
                               min="1"
                               max="{{ guest.max_attendees }}"
                               class="modal-input"
                               placeholder="1"
                               oninvalid="this.setCustomValidity('{% translate "Value must be less than or equal to" %} ' + this.max + ', {% translate "please contact event host" %}')"
                               oninput="this.setCustomValidity('')">
                        <p class="text-[10px] text-stone-400 text-right mt-1">{% blocktranslate with max=guest.max_attendees %}Max: {{ max }}{% endblocktranslate %}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-widest mb-1 text-stone-500">{% translate "Dietary Requirements" %}</label>
                        <textarea name="{{ form.meal_preference.name }}" rows="2" class="modal-input"></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase tracking-widest mb-1 text-stone-500">{% translate "Message for the Couple" %}</label>
                    <textarea name="{{ form.message.name }}" rows="2" class="modal-input"></textarea>
                </div>

                <!-- Button uses Gold class -->
                <button type="submit" class="btn-gold w-full justify-center mt-4 shadow-md">
                    {% translate "Send Response" %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        lucide.createIcons();

        // RSVP Toggle Logic
        document.addEventListener('DOMContentLoaded', function() {
            const rsvpForm = document.getElementById('rsvp-form');

            if (rsvpForm) {
                const radios = document.querySelectorAll('input[name="attending"]');
                const details = document.getElementById('attending_details');
                const attendingYesRadio = document.querySelector('input[name="attending"][value="True"]');

                // Check state for confirmation dialogs
                const hasInitialResponse = "{{ guest.rsvp_details.attending|default:'None' }}" !== "None";
                const hasManualUpdate = rsvpForm.getAttribute('data-manual-status') === 'true';

                function toggleDetails() {
                    if(attendingYesRadio && details) {
                         details.style.display = attendingYesRadio.checked ? 'block' : 'none';
                    }
                }

                radios.forEach(r => r.addEventListener('change', toggleDetails));
                toggleDetails();

                // Confirmation Logic
                rsvpForm.addEventListener('submit', function(event) {
                    let message = "";
                    if (hasManualUpdate) {
                        message = "{% translate 'The event host has manually updated your attendance. Submitting this form will override that update. Do you want to continue?' %}";
                    } else if (hasInitialResponse) {
                        message = "{% translate 'You have already submitted an RSVP. Are you sure you want to change your response?' %}";
                    }

                    if (message && !confirm(message)) {
                        event.preventDefault();
                    }
                });
            }
        });
    </script>
</div>
{% endblock %}
{% extends "invapp/base_invite.html" %}
{% load static %}
{% load i18n %}

{% block page_specific_fonts %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Great+Vibes&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block page_specific_styles %}
<style>
    /* Custom Font Assignments */
    .font-script { font-family: 'Great Vibes', cursive; }
    .font-serif { font-family: 'Cormorant Garamond', serif; }
    .font-sans { font-family: 'Montserrat', sans-serif; }

    /* Paper Texture Effect */
    .bg-paper {
        background-color: #fdfbf7;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
    }

    /* Lemon Theme Colors */
    .text-lemon-gold { color: #d4af37; }
    .text-lemon-yellow { color: #e6b800; }
    .text-leaf-green { color: #556b2f; }

    /* Animations */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    .animate-float { animation: float 6s ease-in-out infinite; }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up { animation: fadeIn 1.2s ease-out forwards; }

    /* Buttons */
    .btn-lemon {
        background-color: #292524; /* Stone-800 */
        color: white;
        padding: 12px 32px;
        border-radius: 9999px;
        font-family: 'Cormorant Garamond', serif;
        font-size: 0.9rem;
        letter-spacing: 0.1em;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .btn-lemon:hover {
        background-color: #d4af37; /* Gold */
        transform: translateY(-2px);
    }

    /* Modal Styles */
    .modal-input {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-top: 6px;
        font-family: 'Montserrat', sans-serif;
        font-size: 16px;
    }
</style>
{% endblock %}

{% block content %}

<!-- x-data handles RSVP modal and Language dropdown -->
<div x-data="{ rsvpOpen: false, langOpen: false }" class="bg-stone-100 min-h-screen flex items-center justify-center p-4 font-sans">

    <!-- Main Card Container -->
    <div class="relative w-full max-w-md bg-paper shadow-2xl overflow-hidden rounded-lg fade-in-up">
        
         <!-- === LANGUAGE SWITCHER (Top Right)          === -->
        <div class="absolute top-4 right-4 z-50" @click.away="langOpen = false">
            {% get_current_language as LANGUAGE_CODE %}
            <div class="relative">
                <!-- Trigger Button (Click instead of Hover for stability) -->
                <button @click="langOpen = !langOpen" type="button" class="flex items-center justify-center space-x-1 bg-white/80 backdrop-blur-md border border-stone-200 shadow-sm rounded-full px-3 py-1 text-xs font-bold text-stone-600 uppercase tracking-wider hover:bg-white transition-all">
                    <i class="fas fa-globe mr-1 text-lemon-gold"></i>
                    <span>{{ LANGUAGE_CODE|default:'ro' }}</span>
                    <i class="fas fa-chevron-down ml-1 text-[10px] text-stone-400"></i>
                </button>

                <!-- Dropdown Menu -->
                <div x-show="langOpen"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute right-0 mt-2 w-32 bg-white rounded-lg shadow-xl overflow-hidden border border-stone-100 z-50 origin-top-right"
                     style="display: none;">

                    <form action="{% url 'set_language' %}" method="post">
                        {% csrf_token %}
                        <!-- Use request.get_full_path to stay on the same page -->
                    <input name="next" type="hidden" value="{% if is_preview %}/{% else %}{{ request.get_full_path }}{% endif %}">

                        <button type="submit" name="language" value="ro" class="w-full text-left px-4 py-3 text-sm text-stone-700 hover:bg-stone-50 transition-colors flex items-center justify-between group border-b border-stone-50">
                            <span class="{% if LANGUAGE_CODE == 'ro' %}font-bold text-lemon-gold{% endif %}">Română</span>
                            {% if LANGUAGE_CODE == 'ro' %}<i class="fas fa-check text-xs text-lemon-gold"></i>{% endif %}
                        </button>

                        <button type="submit" name="language" value="en" class="w-full text-left px-4 py-3 text-sm text-stone-700 hover:bg-stone-50 transition-colors flex items-center justify-between group">
                            <span class="{% if LANGUAGE_CODE == 'en' %}font-bold text-lemon-gold{% endif %}">English</span>
                            {% if LANGUAGE_CODE == 'en' %}<i class="fas fa-check text-xs text-lemon-gold"></i>{% endif %}
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- DECORATIVE CORNER: Top Left Lemon Branch -->
        <!-- STATIC: Removed animate-float -->
        <img src="{% static 'invapp/images/wedding_lemon/Lamaie.png' %}"
             alt="Lemon Decoration"
             class="absolute -top-10 -left-10 w-48 h-48 z-0 pointer-events-none opacity-90 object-contain">

        <!-- DECORATIVE CORNER: Bottom Right Lemon Branch -->
        <!-- STATIC: Removed animate-float -->
        <img src="{% static 'invapp/images/wedding_lemon/Lamai1.png' %}"
             alt="Lemon Decoration"
             class="absolute -bottom-10 -right-10 w-56 h-56 z-0 pointer-events-none opacity-90 rotate-180 object-contain">

        <!-- Content Inner Frame -->
        <div class="relative z-10 m-3 border border-stone-200 min-h-[calc(100vh-2rem)] rounded-sm flex flex-col items-center text-center py-10 px-6">

            <!-- Monogram Logo (Static PNG + Initials) -->
            <div class="mb-6 relative w-32 h-32 mx-auto flex items-center justify-center">
                <!-- Static PNG Background -->
                <img src="{% static 'invapp/images/wedding_lemon/Polygon.png' %}"
                     alt="Monogram Logo"
                     class="absolute inset-0 w-full h-full object-contain opacity-90">

                <!-- Initials Overlay -->
                <div class="relative z-10 font-serif text-4xl text-stone-800 italic" style="text-shadow: 0 1px 2px rgba(255,255,255,0.8);">
                    {{ event.bride_name|slice:":1" }}<span class="text-2xl mx-1">&</span>{{ event.groom_name|slice:":1" }}
                </div>
            </div>

            <!-- Intro -->
            <p class="font-serif uppercase tracking-[0.2em] text-xs text-stone-500 mb-6">
                {% translate "We invite you to be with us" %}
            </p>

            <!-- Names -->
            <div class="mb-8">
                <h1 class="font-script text-6xl text-lemon-gold leading-tight mb-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
                    {{ event.bride_name }}
                    <span class="block text-4xl text-stone-400 my-1">&</span>
                    {{ event.groom_name }}
                </h1>
            </div>

            <!-- Parents -->
            <div class="mb-8 space-y-2">
                <h2 class="font-serif text-[10px] font-bold uppercase tracking-widest text-stone-800 border-b border-stone-200 pb-1 w-3/4 mx-auto">
                    {% translate "With the blessing of parents" %}
                </h2>
                <div class="font-serif italic text-2xl text-stone-700 leading-relaxed">
                    {% if event.bride_parents %}<p>{{ event.bride_parents }}</p>{% endif %}
                    {% if event.groom_parents %}<p>{{ event.groom_parents }}</p>{% endif %}
                </div>
            </div>

            <!-- Godparents -->
            {% if event.godparents.exists %}
            <div class="mb-10 space-y-2">
                <h2 class="font-serif text-[10px] font-bold uppercase tracking-widest text-stone-800 border-b border-stone-200 pb-1 w-3/4 mx-auto">
                    {% translate "Together with godparents" %}
                </h2>
                <div class="font-serif italic text-2xl text-stone-700 leading-relaxed">
                    {% for gp in event.godparents.all %}
                        <p>{{ gp.name }}</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Specific Guest Greeting -->
            <div class="mb-8 font-serif text-stone-600 text-sm italic">
                 {% if guest.honorific == 'family' %}
                    {% blocktranslate with name=guest.name %}Dear The {{ name }} Family{% endblocktranslate %}
                {% elif guest.honorific == 'couple' %}
                    {% blocktranslate with name=guest.name %}Dear The {{ name }} Couple{% endblocktranslate %}
                {% else %}
                     {% blocktranslate with name=guest.name %}Dear {{ name }}{% endblocktranslate %}
                {% endif %}
            </div>

            <!-- Date -->
            <div class="mb-12 relative">
                <div class="absolute inset-0 flex items-center justify-center opacity-10">
                   <i data-lucide="heart" class="w-24 h-24 text-lemon-yellow fill-current"></i>
                </div>
                <p class="font-serif text-4xl text-stone-800 italic border-y border-stone-300 py-2 px-8 inline-block">
                    {{ event.event_date|date:"d F Y" }}
                </p>
            </div>

            <!-- Events Timeline -->
            <div class="w-full space-y-8 mb-10">
                <!-- Ceremony -->
                <div class="flex flex-col items-center">
                    <div class="mb-2 text-leaf-green">
                        <i data-lucide="church" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-serif font-bold uppercase tracking-widest text-sm text-stone-900 mb-1">
                        {% translate "Religious Ceremony" %}
                    </h3>
                    <p class="font-serif text-stone-600 italic">"{{ event.ceremony_location|default:'Biserica' }}"</p>
                    <p class="font-serif text-[10px] text-stone-400">({{ event.ceremony_address }})</p>
                    <p class="font-sans text-xs font-bold text-stone-500 mt-1">{{ event.ceremony_time|time:"H:i" }}</p>
                    {% if event.ceremony_maps_url %}
                    <a href="{{ event.ceremony_maps_url }}" target="_blank" class="text-xs text-lemon-gold underline mt-1">{% translate "View Map" %}</a>
                    {% endif %}
                </div>

                <!-- Party -->
                <div class="flex flex-col items-center">
                    <div class="mb-2 text-leaf-green">
                        <i data-lucide="music" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-serif font-bold uppercase tracking-widest text-sm text-stone-900 mb-1">
                        {% translate "The Party" %}
                    </h3>
                    <p class="font-serif text-stone-600 italic">{{ event.venue_name }}</p>
                    <p class="font-serif text-xs text-stone-400">({{ event.venue_address }})</p>
                    <p class="font-sans text-xs font-bold text-stone-500 mt-1">{{ event.party_time|time:"H:i" }}</p>
                    {% if event.party_maps_url %}
                    <a href="{{ event.party_maps_url }}" target="_blank" class="text-xs text-lemon-gold underline mt-1">{% translate "View Map" %}</a>
                    {% endif %}
                </div>
            </div>

            <!-- Footer / RSVP -->
            <div class="mt-auto pt-6 border-t border-dotted border-stone-300 w-full">
                <p class="font-sans text-[10px] uppercase tracking-wider text-stone-700 mb-2 font-semibold">
                    {% translate "Please confirm your attendance" %}
                </p>
                
                <!-- Interactive RSVP Button -->
                {% if not is_preview %}
                <button @click="rsvpOpen = true" class="mt-6 btn-lemon mx-auto group">
                    <span>{% translate "CONFIRM ATTENDANCE" %}</span>
                    <i data-lucide="send" class="w-3 h-3 group-hover:translate-x-1 transition-transform"></i>
                </button>
                {% endif %}
            </div>

        </div>
    </div>

    <!-- ============================================== -->
    <!-- === RSVP MODAL (Standard Alpine Modal)     === -->
    <!-- ============================================== -->
    {% if not is_preview %}
    <div x-show="rsvpOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center px-4 bg-stone-900/80 backdrop-blur-sm"
         style="display: none;">
         
        <div @click.away="rsvpOpen = false" class="bg-paper w-full max-w-md rounded-lg shadow-2xl p-8 relative overflow-y-auto max-h-[90vh] border border-stone-200">
            <button @click="rsvpOpen = false" class="absolute top-4 right-4 text-stone-400 hover:text-stone-800">
                <i class="fas fa-times text-xl"></i>
            </button>
    
            <h3 class="text-3xl font-script text-center mb-2 text-lemon-gold">{% translate "RSVP" %}</h3>
            
            <form method="POST" action="{% url 'invapp:guest_invite' guest_uuid=guest.unique_id %}" class="space-y-5 mt-6">
                {% csrf_token %}
                
                <div class="text-center mb-6">
                    <label class="block text-xs font-bold uppercase tracking-widest mb-3 text-stone-600">{% translate "Will you attend?" %}</label>
                    <div class="flex justify-center gap-6">
                        {% for radio in form.attending %}
                            <div class="flex items-center gap-2">
                                {{ radio.tag }}
                                <span class="text-sm font-serif italic">{{ radio.choice_label }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
    
                <div id="attending_details" style="display: none;" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-widest mb-1 text-stone-500">{% translate "Number of Guests" %}</label>
                        <input type="number" name="{{ form.number_attending.name }}" min="1" max="{{ guest.max_attendees }}" class="modal-input" placeholder="1">
                        <p class="text-[10px] text-stone-400 text-right mt-1">{% blocktranslate with max=guest.max_attendees %}Max: {{ max }}{% endblocktranslate %}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-widest mb-1 text-stone-500">{% translate "Dietary Requirements" %}</label>
                        <textarea name="{{ form.meal_preference.name }}" rows="2" class="modal-input"></textarea>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold uppercase tracking-widest mb-1 text-stone-500">{% translate "Message for the Couple" %}</label>
                    <textarea name="{{ form.message.name }}" rows="2" class="modal-input"></textarea>
                </div>
    
                <button type="submit" class="btn-lemon w-full justify-center mt-4">
                    {% translate "Send Response" %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}

</div>

{% endblock %}

{% block extra_js %}
<script>
    // Initialize Lucide Icons
    lucide.createIcons();

    // RSVP Toggle Logic
    document.addEventListener('DOMContentLoaded', function() {
        const radios = document.querySelectorAll('input[name="attending"]');
        const details = document.getElementById('attending_details');
        
        function toggleDetails() {
            const isYes = document.querySelector('input[name="attending"][value="True"]:checked');
            if(details) details.style.display = isYes ? 'block' : 'none';
        }

        radios.forEach(r => r.addEventListener('change', toggleDetails));
        toggleDetails();
    });
</script>
{% endblock %}